[English](./README.md) | ä¸­æ–‡

<div align="center">
    <h1>LOAD ANTS</h1>
    <h4>ğŸœğŸœğŸœ è½»é‡çº§ DNS è½¬å‘å™¨ï¼Œå®ç° UDP/TCP æŸ¥è¯¢åˆ° DoH çš„æ— ç¼è½¬æ¢</h4></br>
    <img src="./images/logo.png" alt="logo" width="600">
</div>

<p align="center">
  <a href="#é¡¹ç›®ä»‹ç»">ç®€ä»‹</a> |
  <a href="#å¿«é€Ÿå¼€å§‹">å¿«é€Ÿå¼€å§‹</a> |
  <a href="#æ ¸å¿ƒåŠŸèƒ½">æ ¸å¿ƒåŠŸèƒ½</a> |
  <a href="#é…ç½®è¯¦è§£">é…ç½®è¯¦è§£</a> |
  <a href="#å®‰è£…ä¸è¿›é˜¶ä½¿ç”¨">å®‰è£…ä¸è¿›é˜¶ä½¿ç”¨</a> |
  <a href="#æ·±å…¥äº†è§£">æ·±å…¥äº†è§£</a>
</p>

## é¡¹ç›®ä»‹ç»

**Load Ants** æ˜¯ä¸€æ¬¾é«˜æ€§èƒ½ã€å¤šåŠŸèƒ½çš„ DNS ä»£ç†æœåŠ¡ï¼Œèƒ½å¤Ÿå°†ä¼ ç»Ÿçš„ UDP/TCP DNS æŸ¥è¯¢è½¬æ¢ä¸º DNS-over-HTTPS (DoH)ã€‚å®ƒä½œä¸ºä½¿ç”¨æ ‡å‡† DNS åè®®çš„å®¢æˆ·ç«¯ä¸ç°ä»£å®‰å…¨ DoH æä¾›å•†ä¹‹é—´çš„æ¡¥æ¢ï¼Œæä¾›å¢å¼ºçš„éšç§ä¿æŠ¤ã€å®‰å…¨æ€§å’Œçµæ´»çš„è·¯ç”±åŠŸèƒ½ã€‚

### ä¸ºä»€ä¹ˆé€‰æ‹© DNS-over-HTTPSï¼Ÿ

ä¼ ç»Ÿ DNS æŸ¥è¯¢é‡‡ç”¨æ˜æ–‡ä¼ è¾“ï¼Œè¿™ä½¿ä½ çš„æµè§ˆå†å²å®¹æ˜“é­å—ç›‘æ§ã€åŠ«æŒæˆ–ç¯¡æ”¹ã€‚DoH é€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³è¿™äº›é—®é¢˜ï¼š

-   **DNS æµé‡åŠ å¯†** - é˜²æ­¢ç½‘ç»œä¸­é—´äººçª¥æ¢
-   **éšç§å¢å¼º** - éšè— DNS æŸ¥è¯¢å†…å®¹ï¼Œé¿å…è¢«è¿è¥å•†å’Œå…¶ä»–ç½‘ç»œè§‚å¯Ÿè€…æ•è·
-   **å®‰å…¨æ€§æå‡** - æœ‰æ•ˆé™ä½ DNS æŠ•æ¯’å’Œæ¬ºéª—æ”»å‡»çš„é£é™©
-   **çªç ´ç½‘ç»œé™åˆ¶** - å¸®åŠ©è§„é¿åŸºäº DNS çš„ç½‘ç»œå°é”æŠ€æœ¯

## å¿«é€Ÿå¼€å§‹

æœ¬èŠ‚å°†æŒ‡å¯¼ä½ å¿«é€Ÿéƒ¨ç½²å¹¶è¿è¡Œ Load Antsã€‚æˆ‘ä»¬æ¨èé¦–å…ˆå°è¯•ç›´æ¥è¿è¡Œé¢„ç¼–è¯‘çš„åº”ç”¨ç¨‹åºï¼Œå¦‚æœæ–¹ä¾¿ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Dockerã€‚

### ç¯å¢ƒè¦æ±‚

-   **é€šç”¨**:
    -   ä¸€ä¸ªæ–‡æœ¬ç¼–è¾‘å™¨ï¼Œç”¨äºåˆ›å»ºå’Œä¿®æ”¹é…ç½®æ–‡ä»¶ (`config.yaml`)ã€‚
    -   ç®¡ç†å‘˜/root æƒé™ (å¦‚æœ Load Ants éœ€è¦ç»‘å®šæ ‡å‡† DNS ç«¯å£ 53)ã€‚
-   **ç›´æ¥è¿è¡Œé¢„ç¼–è¯‘ç¨‹åº**:
    -   ä»é¡¹ç›® [å‘å¸ƒé¡µé¢](https://github.com/shengyanli1982/load-ants/releases) ä¸‹è½½çš„å¯¹åº”ä½ æ“ä½œç³»ç»Ÿçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚
-   **ä½¿ç”¨ Docker**:
    -   Docker å·²å®‰è£…å¹¶æ­£åœ¨è¿è¡Œã€‚
-   **(å¯é€‰) ä»æºç æ„å»º (è¿›é˜¶)**:
    -   Rust å·¥å…·é“¾ (Rust 1.84.1ã€ GCC 14.2.0)ã€‚

### æ–¹æ³•ä¸€ï¼šç›´æ¥è¿è¡Œåº”ç”¨ç¨‹åº

è¿™æ˜¯ä½“éªŒ Load Ants æœ€å¿«æ·çš„æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯å¦‚æœä½ å¸Œæœ›åœ¨æœ¬æœºç›´æ¥è¿è¡Œã€‚

1.  **ä¸‹è½½é¢„ç¼–è¯‘ç‰ˆæœ¬**:
    è®¿é—®é¡¹ç›®çš„ [å‘å¸ƒé¡µé¢](https://github.com/shengyanli1982/load-ants/releases)ï¼Œæ‰¾åˆ°å¹¶ä¸‹è½½é€‚ç”¨äºä½ æ“ä½œç³»ç»Ÿçš„æœ€æ–° `load-ants` äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

2.  **å‡†å¤‡é…ç½®æ–‡ä»¶**:
    ä¸‹è½½æˆ–å¤åˆ¶é¡¹ç›®ä¸­çš„ç¤ºä¾‹é…ç½®æ–‡ä»¶ `config.default.yaml` (é€šå¸¸ä¸æºä»£ç ä¸€åŒæä¾›ï¼Œæˆ–é™„åœ¨å‘å¸ƒç‰ˆæœ¬ä¸­)ã€‚å°†å…¶ä¸ä¸‹è½½çš„ `load-ants` äºŒè¿›åˆ¶æ–‡ä»¶æ”¾åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ï¼Œå¹¶é‡å‘½åä¸º `config.yaml`ã€‚

    ```bash
    # å‡è®¾ config.default.yaml å·²è·å–å¹¶æ”¾ç½®åœ¨å½“å‰ç›®å½•
    cp config.default.yaml ./config.yaml
    ```

    ç„¶åï¼Œä½¿ç”¨ä½ å–œæ¬¢çš„æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ `config.yaml` å¹¶è¿›è¡Œä¿®æ”¹ã€‚è‡³å°‘ï¼Œä½ éœ€è¦é…ç½®ä¸€ä¸ªä¸Šæ¸¸ DoH æœåŠ¡å™¨ç»„ (`upstream_groups`)ã€‚å¯ä»¥å‚è€ƒæ–‡æ¡£åç»­çš„ [é…ç½®è¯¦è§£](#é…ç½®è¯¦è§£) éƒ¨åˆ†ã€‚

3.  **èµ‹äºˆæ‰§è¡Œæƒé™ (Linux/macOS)**:
    å‡å¦‚ä½ ä½¿ç”¨çš„æ˜¯ Linux ï¼ˆx86_64ï¼‰ç³»ç»Ÿï¼Œä½ å¯èƒ½éœ€è¦ç»™ä¸‹è½½çš„äºŒè¿›åˆ¶æ–‡ä»¶æ·»åŠ æ‰§è¡Œæƒé™ï¼š

    > ![NOTE]
    > å‡å¦‚ä½ ä½¿ç”¨çš„æ˜¯å…¶ä»–ç³»ç»Ÿï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ã€‚

    ```bash
    chmod +x ./loadants-linux-amd64
    ```

4.  **è¿è¡Œ Load Ants**:
    æ‰“å¼€ç»ˆç«¯ï¼Œå¯¼èˆªåˆ°åŒ…å« `loadants` å’Œ `config.yaml` æ–‡ä»¶çš„ç›®å½•ï¼Œç„¶åæ‰§è¡Œï¼š

    ```bash
    ./loadants-linux-amd64 -c ./config.yaml
    ```

    å¦‚æœ Load Ants é…ç½®ä¸ºç›‘å¬æ ‡å‡† DNS ç«¯å£ (å¦‚ 53)ï¼Œä½ å¯èƒ½éœ€è¦ä½¿ç”¨ç®¡ç†å‘˜æƒé™æ¥å¯åŠ¨å®ƒ (ä¾‹å¦‚ï¼Œåœ¨ Linux/macOS ä¸Šä½¿ç”¨ `sudo ./loadants -c ./config.yaml`ï¼Œåœ¨ Windows ä¸Šä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œå‘½ä»¤æç¤ºç¬¦æˆ– PowerShell)ã€‚
    ç¨‹åºå¯åŠ¨åï¼Œå®ƒä¼šæ ¹æ®é…ç½®æ–‡ä»¶å¼€å§‹å¤„ç† DNS è¯·æ±‚ã€‚æ—¥å¿—ä¿¡æ¯ä¼šç›´æ¥è¾“å‡ºåˆ°ç»ˆç«¯ã€‚

5.  **åŸºæœ¬æµ‹è¯•**:
    ç¨‹åºè¿è¡Œåï¼Œä½ å¯ä»¥ä½¿ç”¨ `dig` (Linux/macOS) æˆ– `nslookup` (Windows) ç­‰å·¥å…·æµ‹è¯• DNS è§£æï¼š

    ```bash
    # å‡è®¾ Load Ants ç›‘å¬åœ¨ 127.0.0.1:53
    dig @127.0.0.1 example.com
    ```

    å¦‚æœä¸€åˆ‡é…ç½®æ­£ç¡®ï¼Œä½ åº”è¯¥èƒ½æ”¶åˆ°æ¥è‡ªä¸Šæ¸¸ DoH æœåŠ¡å™¨çš„ DNS å“åº”ã€‚

6.  **åœæ­¢ç¨‹åº**:
    åœ¨è¿è¡Œ Load Ants çš„ç»ˆç«¯ä¸­ï¼ŒæŒ‰ä¸‹ `Ctrl+C` æ¥åœæ­¢ç¨‹åºã€‚

### æ–¹æ³•äºŒï¼šä½¿ç”¨ Docker éƒ¨ç½² (æ¨è)

Docker æä¾›äº†ä¸€ç§éš”ç¦»ç¯å¢ƒæ¥è¿è¡Œ Load Antsï¼Œæ— éœ€åœ¨ä½ çš„ç³»ç»Ÿä¸Šç›´æ¥å®‰è£…ä»»ä½•ä¾èµ– (é™¤äº† Docker æœ¬èº«)ã€‚

1.  **åˆ›å»ºé…ç½®ç›®å½•**:
    åœ¨ä½ çš„å®¿ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªç›®å½•æ¥å­˜æ”¾é…ç½®æ–‡ä»¶ã€‚

    ```bash
    mkdir -p ./load-ants-config
    ```

2.  **å‡†å¤‡é…ç½®æ–‡ä»¶**:
    å¤åˆ¶é¡¹ç›®ä¸­çš„é»˜è®¤é…ç½®æ–‡ä»¶ (`config.default.yaml`) åˆ°ä½ åˆšåˆ›å»ºçš„ç›®å½•ï¼Œå¹¶æ ¹æ®ä½ çš„éœ€æ±‚è¿›è¡Œç¼–è¾‘ï¼Œå°†å…¶å‘½åä¸º `config.yaml`ã€‚

    ```bash
    # å‡è®¾ä½ å·²å…‹éš†é¡¹ç›®æˆ–ä¸‹è½½äº† config.default.yaml
    cp config.default.yaml ./load-ants-config/config.yaml
    # ä½¿ç”¨ä½ å–œæ¬¢çš„ç¼–è¾‘å™¨ä¿®æ”¹ ./load-ants-config/config.yaml
    ```

    ä½ è‡³å°‘éœ€è¦é…ç½®ä¸Šæ¸¸ DoH æœåŠ¡å™¨ (`upstream_groups`)ã€‚

3.  **è¿è¡Œ Load Ants å®¹å™¨**:

    ```bash
    docker run -d \
      --name load-ants \
      -p 53:53/udp \
      -p 53:53/tcp \
      -p 8080:8080 \
      -v $(pwd)/load-ants-config:/etc/load-ants \
      ghcr.io/shengyanli1982/load-ants-x64:latest -c /etc/load-ants/config.yaml
    ```

    è¯·å°† `ghcr.io/shengyanli1982/load-ants-x64:latest` æ›¿æ¢ä¸ºä½ è‡ªå·±æ„å»ºçš„é•œåƒåç§°æˆ–å®˜æ–¹æä¾›çš„æœ€æ–°é•œåƒã€‚
    å‘½ä»¤è§£é‡Š:

    -   `-d`: åå°è¿è¡Œå®¹å™¨ã€‚
    -   `--name load-ants`: ä¸ºå®¹å™¨å‘½åã€‚
    -   `-p 53:53/udp -p 53:53/tcp`: å°†å®¿ä¸»æœºçš„ DNS ç«¯å£æ˜ å°„åˆ°å®¹å™¨ã€‚
    -   `-p 8080:8080`: æ˜ å°„ç®¡ç†ç«¯å£ (å¥åº·æ£€æŸ¥ã€æŒ‡æ ‡)ã€‚
    -   `-v $(pwd)/load-ants-config:/etc/load-ants`: å°†å®¿ä¸»æœºçš„é…ç½®ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…ã€‚è¯·ç¡®ä¿ `$(pwd)/load-ants-config` è§£æä¸ºç»å¯¹è·¯å¾„ï¼Œæˆ–è€…ç›´æ¥æä¾›ç»å¯¹è·¯å¾„ã€‚
    -   `ghcr.io/shengyanli1982/load-ants-x64:latest`: ä½¿ç”¨çš„ Docker é•œåƒã€‚
    -   `-c /etc/load-ants/config.yaml`: æŒ‡å®šå®¹å™¨å†…é…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚

4.  **åŸºæœ¬æµ‹è¯•**:
    å®¹å™¨å¯åŠ¨åï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æµ‹è¯•æœåŠ¡ï¼š

    -   **æµ‹è¯• DNS è§£æ**:
        ä½¿ç”¨ `dig` æˆ–å…¶ä»– DNS æŸ¥è¯¢å·¥å…·å‘ `127.0.0.1` (æˆ–ä½ çš„æœåŠ¡å™¨ IP) å‘é€æŸ¥è¯¢è¯·æ±‚ã€‚
        ```bash
        dig @127.0.0.1 example.com
        ```
        å¦‚æœé…ç½®æ­£ç¡®ï¼Œä½ åº”è¯¥èƒ½æ”¶åˆ°æ¥è‡ªä¸Šæ¸¸ DoH æœåŠ¡å™¨çš„å“åº”ã€‚
    -   **æŸ¥çœ‹æ—¥å¿—**:
        æ£€æŸ¥ Load Ants çš„è¿è¡Œæ—¥å¿—ï¼Œäº†è§£å…¶å·¥ä½œçŠ¶æ€æˆ–æ’æŸ¥é—®é¢˜ã€‚
        ```bash
        docker logs load-ants
        ```

5.  **åœæ­¢å’Œç§»é™¤å®¹å™¨** (å¦‚æœéœ€è¦):
    ```bash
    docker stop load-ants
    docker rm load-ants
    ```

## æ ¸å¿ƒåŠŸèƒ½

-   ğŸ”„ **åè®®è½¬æ¢**
    -   æ— ç¼å°† UDP/53 å’Œ TCP/53 DNS è¯·æ±‚è½¬æ¢ä¸º DoH (RFC 8484)
    -   å…¨é¢æ”¯æŒ GET å’Œ POST HTTP æ–¹æ³•
    -   å¤„ç†å¤šç§å†…å®¹æ ¼å¼ï¼ŒåŒ…æ‹¬ `application/dns-message` å’Œ `application/dns-json`
-   ğŸ§  **æ™ºèƒ½è·¯ç”±**
    -   **çµæ´»åŒ¹é…** - æ ¹æ®åŸŸåæ¨¡å¼ç²¾å‡†è·¯ç”± DNS æŸ¥è¯¢ï¼š
        -   ç²¾ç¡®åŸŸååŒ¹é…
        -   é€šé…ç¬¦åŸŸååŒ¹é…ï¼ˆå¦‚ `*.example.com`ï¼‰
        -   æ­£åˆ™è¡¨è¾¾å¼åŸŸååŒ¹é…
    -   **è‡ªå®šä¹‰æ“ä½œ** - ä¸ºæ¯æ¬¡åŒ¹é…å®šä¹‰ç²¾ç¡®å¤„ç†æ–¹å¼ï¼š
        -   è½¬å‘è‡³ç‰¹å®šä¸Šæ¸¸ DoH ç»„
        -   æ‹¦æˆªæŸ¥è¯¢ï¼ˆè¿”å› NXDOMAINï¼‰
    -   **è¿œç¨‹è§„åˆ™åˆ—è¡¨** - æ”¯æŒä» URL åŠ è½½å’Œåˆå¹¶å¤–éƒ¨è§„åˆ™åˆ—è¡¨ (ä¾‹å¦‚ V2Ray æ ¼å¼çš„ `reject-list.txt`, `proxy-list.txt`)
-   ğŸŒ **çµæ´»çš„ä¸Šæ¸¸ç®¡ç†**
    -   **åˆ†ç»„æœºåˆ¶** - å°† DoH æœåŠ¡å™¨ç»„ç»‡æˆç‹¬ç«‹é…ç½®çš„é€»è¾‘ç»„
    -   **è´Ÿè½½å‡è¡¡** - ä¸ºæ¯ä¸ªç»„é…ç½®é«˜æ•ˆå‡è¡¡ç­–ç•¥ï¼š
        -   è½®è¯¢ (RR) - åœ¨æœåŠ¡å™¨ä¹‹é—´å‡è¡¡åˆ†é…è¯·æ±‚
        -   åŠ æƒè½®è¯¢ (WRR) - æ ¹æ®æƒé‡ä¼˜å…ˆè°ƒåº¦æœåŠ¡å™¨
        -   éšæœºåˆ†é… - éç¡®å®šæ€§é€‰æ‹©ï¼Œå¢å¼ºéšç§ä¿æŠ¤
    -   **è®¤è¯æ”¯æŒ** - ä¸éœ€è¦è®¤è¯çš„ç§æœ‰ DoH æä¾›å•†å®‰å…¨é€šä¿¡ï¼š
        -   HTTP åŸºæœ¬è®¤è¯
        -   Bearer ä»¤ç‰Œè®¤è¯
    -   **èµ„æºä¼˜åŒ–** - æ‰€æœ‰ä¸Šæ¸¸ç»„å…±äº« HTTP å®¢æˆ·ç«¯è¿æ¥æ± ï¼Œæå‡èµ„æºåˆ©ç”¨ç‡
-   âš¡ **æ€§èƒ½ä¼˜åŒ–**
    -   **æ™ºèƒ½ç¼“å­˜** - å†…ç½® DNS ç¼“å­˜æœºåˆ¶ï¼Œæ˜¾è‘—é™ä½å»¶è¿Ÿå’Œä¸Šæ¸¸è´Ÿè½½
        -   **æ­£å‘ç¼“å­˜** - å­˜å‚¨æˆåŠŸçš„ DNS å“åº”ï¼ŒåŠ é€Ÿè§£æè¿‡ç¨‹
        -   **è´Ÿå‘ç¼“å­˜** - ç¼“å­˜é”™è¯¯å“åº”ï¼ˆNXDOMAINã€ServFail ç­‰ï¼‰ï¼Œé¿å…å¯¹ä¸å­˜åœ¨åŸŸåçš„é‡å¤æŸ¥è¯¢
        -   **å¯è°ƒæ•´ TTL** - ä¸ºæ­£å‘å’Œè´Ÿå‘ç¼“å­˜æ¡ç›®è®¾ç½®å·®å¼‚åŒ–çš„ç”Ÿå­˜æ—¶é—´
    -   **è¿æ¥æ± å¤ç”¨** - é«˜æ•ˆå¤ç”¨ HTTP è¿æ¥ï¼Œæå‡æ€§èƒ½
    -   **TTL ä¼˜åŒ–** - çµæ´»é…ç½®ç¼“å­˜å“åº”çš„æœ€å°å’Œæœ€å¤§ TTL å€¼
-   ğŸ” **é«˜å¯é æ€§**
    -   **æ™ºèƒ½é‡è¯•** - è‡ªåŠ¨é‡è¯•å¤±è´¥çš„ DoH è¯·æ±‚ï¼Œæ”¯æŒå¯é…ç½®çš„å°è¯•æ¬¡æ•°å’Œå»¶è¿Ÿ
    -   **è¶…æ—¶æ§åˆ¶** - ç²¾ç¡®è°ƒæ•´è¿æ¥å’Œè¯·æ±‚è¶…æ—¶å‚æ•°
-   âš™ï¸ **ç®¡ç†èƒ½åŠ›**
    -   **YAML é…ç½®** - ç®€æ´ã€æ˜“è¯»çš„é…ç½®æ–¹å¼
    -   **é…ç½®æ ¡éªŒ** - å¯åŠ¨æ—¶æˆ–æµ‹è¯•æ¨¡å¼ä¸‹è¿›è¡Œä¸¥æ ¼é…ç½®éªŒè¯
    -   **å¥åº·æ£€æŸ¥** - ä¸ºè¿ç»´å›¢é˜Ÿæä¾›å®Œæ•´çš„ç›‘æ§é›†æˆæ¥å£
    -   **Prometheus æŒ‡æ ‡** - é€šè¿‡ `/metrics` ç«¯ç‚¹æä¾›å…¨é¢çš„ç›‘æ§æŒ‡æ ‡

## é…ç½®è¯¦è§£

Load Ants ä½¿ç”¨ YAML æ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´çš„é…ç½®é€‰é¡¹å‚è€ƒã€‚å»ºè®®ä» `config.default.yaml` å¼€å§‹ä¿®æ”¹ã€‚

### æœåŠ¡å™¨é…ç½® (server)

| å‚æ•°         | ç±»å‹   | é»˜è®¤å€¼         | æè¿°                                        | æœ‰æ•ˆèŒƒå›´            |
| ------------ | ------ | -------------- | ------------------------------------------- | ------------------- |
| listen_udp   | å­—ç¬¦ä¸² | "127.0.0.1:53" | UDP DNS ç›‘å¬åœ°å€å’Œç«¯å£ï¼ˆå¿…é€‰ï¼‰              | æœ‰æ•ˆçš„ IP:ç«¯å£ æ ¼å¼ |
| listen_tcp   | å­—ç¬¦ä¸² | "127.0.0.1:53" | TCP DNS ç›‘å¬åœ°å€å’Œç«¯å£ï¼ˆå¿…é€‰ï¼‰              | æœ‰æ•ˆçš„ IP:ç«¯å£ æ ¼å¼ |
| listen_http  | å­—ç¬¦ä¸² | "127.0.0.1:80" | HTTP DoH æœåŠ¡å™¨ç›‘å¬åœ°å€å’Œç«¯å£ï¼ˆå¿…é€‰ï¼‰       | æœ‰æ•ˆçš„ IP:ç«¯å£ æ ¼å¼ |
| tcp_timeout  | æ•´æ•°   | 10             | TCP è¿æ¥ç©ºé—²è¶…æ—¶ï¼ˆç§’ï¼‰ï¼ˆå¯é€‰ï¼Œé»˜è®¤å€¼: 10ï¼‰  | 1-3600              |
| http_timeout | æ•´æ•°   | 30             | HTTP è¿æ¥ç©ºé—²è¶…æ—¶ï¼ˆç§’ï¼‰ï¼ˆå¯é€‰ï¼Œé»˜è®¤å€¼: 30ï¼‰ | 1-3600              |

### å¥åº·æ£€æŸ¥é…ç½® (health)

æ­¤éƒ¨åˆ†é…ç½®ç”¨äºæš´éœ²å¥åº·æ£€æŸ¥å’Œç›‘æ§æŒ‡æ ‡çš„ HTTP æœåŠ¡ã€‚

| å‚æ•°   | ç±»å‹   | é»˜è®¤å€¼           | æè¿°                                                       | æœ‰æ•ˆèŒƒå›´            |
| ------ | ------ | ---------------- | ---------------------------------------------------------- | ------------------- |
| listen | å­—ç¬¦ä¸² | "127.0.0.1:8080" | å¥åº·æ£€æŸ¥æœåŠ¡ç›‘å¬åœ°å€å’Œç«¯å£ï¼ˆå¦‚æœæä¾› health éƒ¨åˆ†ï¼Œåˆ™å¿…é€‰ï¼‰ | æœ‰æ•ˆçš„ IP:ç«¯å£ æ ¼å¼ |

### ç¼“å­˜é…ç½® (cache)

ç¼“å­˜é…ç½®å…è®¸ç²¾ç»†è°ƒæ•´ DNS å“åº”çš„ç¼“å­˜è¡Œä¸ºã€‚

| å‚æ•°         | ç±»å‹   | é»˜è®¤å€¼ | æè¿°                                                                              | æœ‰æ•ˆèŒƒå›´   |
| ------------ | ------ | ------ | --------------------------------------------------------------------------------- | ---------- |
| enabled      | å¸ƒå°”å€¼ | true   | æ˜¯å¦å¯ç”¨ç¼“å­˜ï¼ˆå¦‚æœæä¾› cache éƒ¨åˆ†ï¼Œåˆ™å¿…é€‰ï¼‰                                       | true/false |
| max_size     | æ•´æ•°   | 10000  | æœ€å¤§ç¼“å­˜æ¡ç›®æ•°ï¼ˆå¦‚æœæä¾› cache éƒ¨åˆ†ï¼Œåˆ™å¿…é€‰ï¼‰                                     | 10-1000000 |
| min_ttl      | æ•´æ•°   | 60     | æœ€å° TTLï¼ˆç§’ï¼‰ï¼Œä¼šè¦†ç›–åŸå§‹å“åº”ä¸­æ›´å°çš„ TTL å€¼ï¼ˆå¦‚æœæä¾› cache éƒ¨åˆ†ï¼Œåˆ™å¿…é€‰ï¼‰      | 1-86400    |
| max_ttl      | æ•´æ•°   | 3600   | æ‰€æœ‰ç¼“å­˜æ¡ç›®çš„æœ€å¤§ç”Ÿå­˜æ—¶é—´ä¸Šé™ï¼ˆç§’ï¼‰ï¼ˆå¦‚æœæä¾› cache éƒ¨åˆ†ï¼Œåˆ™å¿…é€‰ï¼‰               | 1-86400    |
| negative_ttl | æ•´æ•°   | 300    | è´Ÿå‘ç¼“å­˜ TTLï¼ˆç§’ï¼‰ï¼Œç”¨äºç¼“å­˜é”™è¯¯ã€ä¸å­˜åœ¨åŸŸåç­‰å“åº”ï¼ˆå¦‚æœæä¾› cache éƒ¨åˆ†ï¼Œåˆ™å¿…é€‰ï¼‰ | 1-86400    |

**è´Ÿå‘ç¼“å­˜è¯´æ˜**:
è´Ÿå‘ç¼“å­˜æ˜¯ä¸€ç§é‡è¦çš„æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ï¼Œå®ƒå°† DNS é”™è¯¯å“åº”ï¼ˆå¦‚ NXDOMAIN æˆ– ServFailï¼‰ç¼“å­˜æŒ‡å®šæ—¶é—´ã€‚è¿™èƒ½æœ‰æ•ˆé˜²æ­¢å¯¹ä¸å­˜åœ¨æˆ–æš‚æ—¶æ— æ³•è§£æçš„åŸŸåé‡å¤æŸ¥è¯¢ä¸Šæ¸¸æœåŠ¡å™¨ï¼Œä»è€Œå‡å°‘å»¶è¿Ÿå¹¶é™ä½ä¸Šæ¸¸æœåŠ¡å™¨è´Ÿè½½ã€‚

### HTTP å®¢æˆ·ç«¯é…ç½® (http_client)

æ­¤é…ç½®åº”ç”¨äºæ‰€æœ‰å‘å‘ä¸Šæ¸¸ DoH æœåŠ¡å™¨çš„ HTTP è¯·æ±‚ã€‚

| å‚æ•°            | ç±»å‹   | é»˜è®¤å€¼ | æè¿°                                                | æœ‰æ•ˆèŒƒå›´   |
| --------------- | ------ | ------ | --------------------------------------------------- | ---------- |
| connect_timeout | æ•´æ•°   | 5      | è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰ï¼ˆå¦‚æœæä¾› http_client éƒ¨åˆ†ï¼Œåˆ™å¿…é€‰ï¼‰ | 1-120      |
| request_timeout | æ•´æ•°   | 10     | è¯·æ±‚è¶…æ—¶ï¼ˆç§’ï¼‰ï¼ˆå¦‚æœæä¾› http_client éƒ¨åˆ†ï¼Œåˆ™å¿…é€‰ï¼‰ | 1-1200     |
| idle_timeout    | æ•´æ•°   | 60     | ç©ºé—²è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰ï¼ˆå¯é€‰ï¼‰                          | 5-1800     |
| keepalive       | æ•´æ•°   | 60     | TCP Keepaliveï¼ˆç§’ï¼‰ï¼ˆå¯é€‰ï¼‰                         | 5-600      |
| agent           | å­—ç¬¦ä¸² | -      | HTTP ç”¨æˆ·ä»£ç†ï¼ˆå¯é€‰ï¼‰                               | éç©ºå­—ç¬¦ä¸² |

### ä¸Šæ¸¸ DoH æœåŠ¡å™¨ç»„é…ç½® (upstream_groups)

ä½ å¯ä»¥å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªä¸Šæ¸¸ DoH æœåŠ¡å™¨ç»„ï¼Œæ¯ä¸ªç»„å¯ä»¥åŒ…å«å¤šä¸ªæœåŠ¡å™¨ï¼Œå¹¶å…·æœ‰ç‹¬ç«‹çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ã€é‡è¯•æœºåˆ¶å’Œä»£ç†è®¾ç½®ã€‚

| å‚æ•°     | ç±»å‹   | é»˜è®¤å€¼ | æè¿°                                     | æœ‰æ•ˆèŒƒå›´                           |
| -------- | ------ | ------ | ---------------------------------------- | ---------------------------------- |
| name     | å­—ç¬¦ä¸² | -      | ç»„åç§° (å¿…é€‰, éœ€å”¯ä¸€)                    | éç©ºå­—ç¬¦ä¸²                         |
| strategy | å­—ç¬¦ä¸² | -      | è´Ÿè½½å‡è¡¡ç­–ç•¥ (å¿…é€‰)                      | "roundrobin", "weighted", "random" |
| servers  | æ•°ç»„   | -      | æ­¤ç»„ä¸­çš„ DoH æœåŠ¡å™¨åˆ—è¡¨ (å¿…é€‰, è‡³å°‘ä¸€ä¸ª) | -                                  |
| retry    | å¯¹è±¡   | -      | é’ˆå¯¹æ­¤ç»„çš„è¯·æ±‚é‡è¯•é…ç½®ï¼ˆå¯é€‰ï¼‰           | å‚ç…§ä¸‹æ–¹é‡è¯•é…ç½®                   |
| proxy    | å­—ç¬¦ä¸² | -      | è®¿é—®æ­¤ç»„æœåŠ¡å™¨æ—¶ä½¿ç”¨çš„ä»£ç† (å¯é€‰)        | æœ‰æ•ˆçš„ HTTP/SOCKS5 ä»£ç† URL        |

#### æœåŠ¡å™¨é…ç½® (servers)

`upstream_groups` ä¸­ `servers` æ•°ç»„çš„æ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€ä¸ª DoH æœåŠ¡å™¨ã€‚

| å‚æ•°         | ç±»å‹   | é»˜è®¤å€¼    | æè¿°                                                                                       | æœ‰æ•ˆèŒƒå›´                     |
| ------------ | ------ | --------- | ------------------------------------------------------------------------------------------ | ---------------------------- |
| url          | å­—ç¬¦ä¸² | -         | DoH æœåŠ¡å™¨ URL (å¿…é€‰)                                                                      | æœ‰æ•ˆçš„ HTTP(S) URLï¼ŒåŒ…å«è·¯å¾„ |
| weight       | æ•´æ•°   | 1         | æƒé‡ (ä»…å½“ç»„ç­–ç•¥ä¸º `weighted` æ—¶æœ‰æ•ˆ) (å¯é€‰ï¼Œé»˜è®¤å€¼: 1)                                    | 1-65535                      |
| method       | å­—ç¬¦ä¸² | "post"    | DoH è¯·æ±‚æ–¹æ³• (GET æˆ– POST) (å¯é€‰ï¼Œé»˜è®¤å€¼: post)                                            | "get", "post"                |
| content_type | å­—ç¬¦ä¸² | "message" | DoH å†…å®¹ç±»å‹ (`application/dns-message` æˆ– `application/dns-json`) (å¯é€‰ï¼Œé»˜è®¤å€¼: message) | "message", "json"            |
| auth         | å¯¹è±¡   | -         | è®¿é—®æ­¤æœåŠ¡å™¨çš„è®¤è¯é…ç½®ï¼ˆå¯é€‰ï¼‰                                                             | å‚ç…§ä¸‹æ–¹è®¤è¯é…ç½®             |

**DoH å†…å®¹ç±»å‹çš„æŠ€æœ¯å› ç´ ï¼š**

-   `message` (`application/dns-message`)ï¼šå®ç° RFC 8484 æ ‡å‡†åè®®ï¼ŒåŒæ—¶æ”¯æŒ GET å’Œ POST ä¸¤ç§ HTTP æ–¹æ³•ã€‚è¯¥æ ¼å¼ç›´æ¥å°è£…äºŒè¿›åˆ¶ DNS æ¶ˆæ¯ï¼Œæ˜¯è·¨ DoH æä¾›å•†å®ç°æœ€ä½³å…¼å®¹æ€§å’Œæ€§èƒ½çš„æ¨èé€‰é¡¹ã€‚

-   `json` (`application/dns-json`)ï¼šå®ç° Google çš„ DNS æŸ¥è¯¢ JSON API è§„èŒƒï¼Œè¯¥è§„èŒƒ**ä»…æ”¯æŒ GET æ–¹æ³•**ã€‚æ­¤æ ¼å¼ä¸»è¦ç”¨äºå…¼å®¹éœ€è¦ JSON æ ¼å¼å“åº”çš„ç‰¹å®šå®¢æˆ·ç«¯å®ç°ã€‚

é…ç½® `content_type: "json"` æ—¶ï¼Œä½ **å¿…é¡»**åŒæ—¶æŒ‡å®š `method: "get"`ã€‚ç³»ç»Ÿçš„é…ç½®éªŒè¯å™¨å¼ºåˆ¶æ‰§è¡Œæ­¤åè®®è¦æ±‚ï¼Œå¹¶å°†æ‹’ç»ä»»ä½•å°è¯•å°† `content_type: "json"` ä¸ `method: "post"` ç»„åˆçš„é…ç½®ï¼Œå› ä¸ºè¿™ç§ç»„åˆè¿åäº† Google Public DNS è§„èŒƒï¼Œä¼šå¯¼è‡´æŸ¥è¯¢å¤±è´¥ã€‚

#### è®¤è¯é…ç½® (auth)

ç”¨äº `upstream_groups.servers.auth`ã€‚

| å‚æ•°     | ç±»å‹   | é»˜è®¤å€¼ | æè¿°                                   | æœ‰æ•ˆèŒƒå›´          |
| -------- | ------ | ------ | -------------------------------------- | ----------------- |
| type     | å­—ç¬¦ä¸² | -      | è®¤è¯ç±»å‹ (å¦‚æœæä¾› auth éƒ¨åˆ†ï¼Œåˆ™å¿…é€‰)  | "basic", "bearer" |
| username | å­—ç¬¦ä¸² | -      | ç”¨æˆ·åï¼ˆå¦‚æœ type ä¸º `basic`ï¼Œåˆ™å¿…é€‰ï¼‰ | éç©ºå­—ç¬¦ä¸²        |
| password | å­—ç¬¦ä¸² | -      | å¯†ç ï¼ˆå¦‚æœ type ä¸º `basic`ï¼Œåˆ™å¿…é€‰ï¼‰   | éç©ºå­—ç¬¦ä¸²        |
| token    | å­—ç¬¦ä¸² | -      | ä»¤ç‰Œï¼ˆå¦‚æœ type ä¸º `bearer`ï¼Œåˆ™å¿…é€‰ï¼‰  | éç©ºå­—ç¬¦ä¸²        |

#### é‡è¯•é…ç½® (retry)

ç”¨äº `upstream_groups.retry`ã€‚

| å‚æ•°     | ç±»å‹ | é»˜è®¤å€¼ | æè¿°                             | æœ‰æ•ˆèŒƒå›´ |
| -------- | ---- | ------ | -------------------------------- | -------- |
| attempts | æ•´æ•° | 3      | é‡è¯•æ¬¡æ•° (å¯é€‰ï¼Œé»˜è®¤å€¼: 3)       | 1-100    |
| delay    | æ•´æ•° | 1      | åˆå§‹å»¶è¿Ÿï¼ˆç§’ï¼‰ (å¯é€‰ï¼Œé»˜è®¤å€¼: 1) | 1-120    |

### è·¯ç”±è§„åˆ™é…ç½® (static_rules)

å®šä¹‰æœ¬åœ°é™æ€è·¯ç”±è§„åˆ™ã€‚Load Ants é‡‡ç”¨åŸºäºä¼˜å…ˆçº§çš„åŒ¹é…ç³»ç»Ÿè¿›è¡Œ DNS è·¯ç”±å†³ç­–ï¼š

1.  **ç²¾ç¡®åŒ¹é…** (`exact`) - å®Œå…¨åŒ¹é…å®Œæ•´åŸŸåï¼ˆå¦‚ `example.com`ï¼‰ã€‚æœ€é«˜ä¼˜å…ˆçº§ã€‚
2.  **ç‰¹å®šé€šé…ç¬¦åŒ¹é…** (`wildcard`) - ä½¿ç”¨é€šé…ç¬¦åŒ¹é…ç‰¹å®šåŸŸåæ¨¡å¼ï¼ˆå¦‚ `*.example.com`ï¼‰ã€‚
3.  **æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…** (`regex`) - ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œå¤æ‚åŒ¹é…ï¼ˆå¦‚ `^(mail|audio)\\.google\\.com$`ï¼‰ã€‚
4.  **å…¨å±€é€šé…ç¬¦åŒ¹é…** (`wildcard` æ¨¡å¼ä¸º `*`) - åŒ¹é…ä»»ä½•åŸŸåã€‚æœ€ä½ä¼˜å…ˆçº§ã€‚

é€šå¸¸ï¼Œå…¨å±€é€šé…ç¬¦ï¼ˆ`*`ï¼‰åº”ä½œä¸ºæœ€åä¸€æ¡è§„åˆ™ï¼Œä½œä¸ºå…¶ä»–è§„åˆ™éƒ½ä¸åŒ¹é…æ—¶çš„é»˜è®¤é€‰é¡¹ã€‚

| å‚æ•°     | ç±»å‹   | é»˜è®¤å€¼ | æè¿°                                         | æœ‰æ•ˆèŒƒå›´                     |
| -------- | ------ | ------ | -------------------------------------------- | ---------------------------- |
| match    | å­—ç¬¦ä¸² | -      | åŒ¹é…ç±»å‹ (å¿…é€‰)                              | "exact", "wildcard", "regex" |
| patterns | æ•°ç»„   | -      | åŒ¹é…æ¨¡å¼åˆ—è¡¨ (å¿…é€‰, è‡³å°‘ä¸€ä¸ªæ¨¡å¼)            | éç©ºå­—ç¬¦ä¸²æ•°ç»„               |
| action   | å­—ç¬¦ä¸² | -      | è·¯ç”±åŠ¨ä½œ (å¿…é€‰)                              | "forward", "block"           |
| target   | å­—ç¬¦ä¸² | -      | ç›®æ ‡ä¸Šæ¸¸ç»„ (å½“ `action` ä¸º `forward` æ—¶å¿…é€‰) | å·²å®šä¹‰çš„ä¸Šæ¸¸ç»„åç§°           |

### è¿œç¨‹è§„åˆ™é…ç½® (remote_rules)

`remote_rules` å…è®¸ç³»ç»Ÿä»å¤–éƒ¨ URL è·å–åŸŸåè§„åˆ™åˆ—è¡¨ï¼ˆå¦‚é˜»æ­¢åˆ—è¡¨ã€ä»£ç†åˆ—è¡¨ç­‰ï¼‰ï¼Œå¹¶ä¸æœ¬åœ°é™æ€è§„åˆ™åˆå¹¶ã€‚è¿™äº›è§„åˆ™å°†æ ¹æ®å…¶ `action`ï¼ˆblock æˆ– forwardï¼‰å’Œä»è¿œç¨‹æ–‡ä»¶è§£æå‡ºçš„åŒ¹é…ç±»å‹ï¼ˆexact, wildcard, regexï¼‰æ•´åˆåˆ°è·¯ç”±å¼•æ“ä¸­ï¼Œå¹¶éµå¾ªä¸é™æ€è§„åˆ™ç›¸åŒçš„ä¼˜å…ˆçº§é€»è¾‘ã€‚

| å‚æ•°     | ç±»å‹   | é»˜è®¤å€¼   | æè¿°                                                                        | æœ‰æ•ˆèŒƒå›´                             |
| -------- | ------ | -------- | --------------------------------------------------------------------------- | ------------------------------------ |
| type     | å­—ç¬¦ä¸² | "url"    | è§„åˆ™ç±»å‹ï¼Œç›®å‰ä»…æ”¯æŒ "url" (å¿…é€‰)                                           | "url"                                |
| url      | å­—ç¬¦ä¸² | -        | è¿œç¨‹è§„åˆ™æ–‡ä»¶çš„ URL (å¿…é€‰)                                                   | æœ‰æ•ˆçš„ HTTP(S) URL                   |
| format   | å­—ç¬¦ä¸² | "v2ray"  | è§„åˆ™æ–‡ä»¶æ ¼å¼ (å¿…é€‰)                                                         | "v2ray" (æœªæ¥å¯èƒ½æ”¯æŒ "clash" ç­‰)    |
| action   | å­—ç¬¦ä¸² | -        | åº”ç”¨äºæ­¤è§„åˆ™åˆ—è¡¨ä¸­æ‰€æœ‰åŸŸåçš„åŠ¨ä½œ (å¿…é€‰)                                     | "block", "forward"                   |
| target   | å­—ç¬¦ä¸² | -        | ç›®æ ‡ä¸Šæ¸¸ç»„ (å½“ `action` ä¸º `forward` æ—¶å¿…é€‰)                                | å·²å®šä¹‰çš„ä¸Šæ¸¸ç»„åç§°                   |
| retry    | å¯¹è±¡   | -        | è·å–è§„åˆ™çš„é‡è¯•ç­–ç•¥ (å¯é€‰)                                                   | å‚ç…§ä¸‹æ–¹ `remote_rules` å†…çš„é‡è¯•é…ç½® |
| proxy    | å­—ç¬¦ä¸² | -        | è·å–è§„åˆ™æ—¶ä½¿ç”¨çš„ HTTP/SOCKS5 ä»£ç† (å¯é€‰)                                    | æœ‰æ•ˆçš„ä»£ç† URL                       |
| auth     | å¯¹è±¡   | -        | è®¿é—®è¿œç¨‹è§„åˆ™ URL çš„è®¤è¯é…ç½® (å¯é€‰)                                          | å‚ç…§ä¸‹æ–¹ `remote_rules` å†…çš„è®¤è¯é…ç½® |
| max_size | æ•´æ•°   | 10485760 | è¿œç¨‹è§„åˆ™æ–‡ä»¶çš„æœ€å¤§å¤§å° (å­—èŠ‚), ä¾‹å¦‚ 10485760 è¡¨ç¤º 10MB (å¯é€‰ï¼Œé»˜è®¤å€¼: 10MB) | 1 - N (ä¾‹å¦‚ 10485760 for 10MB)       |

#### é‡è¯•é…ç½® (retry) - remote_rules å†…

ç”¨äº `remote_rules.retry`ã€‚

| å‚æ•°     | ç±»å‹ | é»˜è®¤å€¼ | æè¿°                             | æœ‰æ•ˆèŒƒå›´ |
| -------- | ---- | ------ | -------------------------------- | -------- |
| attempts | æ•´æ•° | 3      | é‡è¯•æ¬¡æ•° (å¯é€‰ï¼Œé»˜è®¤å€¼: 3)       | 1-100    |
| delay    | æ•´æ•° | 1      | åˆå§‹å»¶è¿Ÿï¼ˆç§’ï¼‰ (å¯é€‰ï¼Œé»˜è®¤å€¼: 1) | 1-120    |

#### è®¤è¯é…ç½® (auth) - remote_rules å†…

ç”¨äº `remote_rules.auth`ï¼Œç»“æ„ä¸ `upstream_groups.servers.auth` ç›¸åŒã€‚

| å‚æ•°     | ç±»å‹   | é»˜è®¤å€¼ | æè¿°                                   | æœ‰æ•ˆèŒƒå›´          |
| -------- | ------ | ------ | -------------------------------------- | ----------------- |
| type     | å­—ç¬¦ä¸² | -      | è®¤è¯ç±»å‹ (å¦‚æœæä¾› auth éƒ¨åˆ†ï¼Œåˆ™å¿…é€‰)  | "basic", "bearer" |
| username | å­—ç¬¦ä¸² | -      | ç”¨æˆ·åï¼ˆå¦‚æœ type ä¸º `basic`ï¼Œåˆ™å¿…é€‰ï¼‰ | éç©ºå­—ç¬¦ä¸²        |
| password | å­—ç¬¦ä¸² | -      | å¯†ç ï¼ˆå¦‚æœ type ä¸º `basic`ï¼Œåˆ™å¿…é€‰ï¼‰   | éç©ºå­—ç¬¦ä¸²        |
| token    | å­—ç¬¦ä¸² | -      | ä»¤ç‰Œï¼ˆå¦‚æœ type ä¸º `bearer`ï¼Œåˆ™å¿…é€‰ï¼‰  | éç©ºå­—ç¬¦ä¸²        |

**`remote_rules` ç¤ºä¾‹:**

```yaml
remote_rules:
    # ä»URLè·å–é˜»æ­¢åˆ—è¡¨ï¼Œå¹¶ä½¿ç”¨Bearerè®¤è¯å’Œä»£ç†
    - type: "url"
      url: "https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/reject-list.txt"
      format: "v2ray"
      action: "block"
      retry:
          attempts: 3
          delay: 1
      proxy: "http://user:pass@proxyserver:port"
      auth:
          type: "bearer"
          token: "your_secure_token"
      max_size: 1048576 # 1MB

    # ä»URLè·å–è½¬å‘åˆ—è¡¨ï¼ŒæŒ‡å®šç›®æ ‡ä¸Šæ¸¸ç»„
    - type: "url"
      url: "https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/proxy-list.txt"
      format: "v2ray"
      action: "forward"
      target: "google_public" # è½¬å‘åˆ°åä¸º "google_public" çš„ä¸Šæ¸¸ç»„
```

### é…ç½®ç¤ºä¾‹

è¿™æ˜¯ä¸€ä¸ªåŒ…å«å¤§éƒ¨åˆ†å¸¸ç”¨é…ç½®çš„å®Œæ•´ç¤ºä¾‹ï¼š

```yaml
# Load Ants é…ç½®ç¤ºä¾‹

# æœåŠ¡å™¨ç›‘å¬è®¾ç½®
server:
    listen_udp: "0.0.0.0:53" # UDP ç›‘å¬åœ°å€å’Œç«¯å£
    listen_tcp: "0.0.0.0:53" # TCP ç›‘å¬åœ°å€å’Œç«¯å£
    listen_http: "0.0.0.0:80" # HTTP DoH æœåŠ¡å™¨ç›‘å¬åœ°å€å’Œç«¯å£
    tcp_timeout: 10 # TCPè¿æ¥ç©ºé—²è¶…æ—¶(ç§’)
    http_timeout: 30 # HTTPè¿æ¥ç©ºé—²è¶…æ—¶(ç§’)

# å¥åº·æ£€æŸ¥ä¸ç®¡ç†æœåŠ¡å™¨è®¾ç½®
admin:
    listen: "0.0.0.0:8080" # å¥åº·æ£€æŸ¥æœåŠ¡å™¨ç›‘å¬åœ°å€å’Œç«¯å£

# ç¼“å­˜è®¾ç½®
cache:
    enabled: true
    max_size: 10000 # æœ€å¤§ç¼“å­˜æ¡ç›®æ•°
    min_ttl: 60 # ç¼“å­˜æ¡ç›®æœ€å° TTLï¼ˆç§’ï¼‰
    max_ttl: 3600 # ç¼“å­˜æ¡ç›®æœ€å¤§ TTLï¼ˆç§’ï¼‰
    negative_ttl: 300 # è´Ÿé¢ç¼“å­˜ TTLï¼ˆç§’ï¼‰ï¼Œç”¨äºç¼“å­˜é”™è¯¯å“åº”

# HTTP å®¢æˆ·ç«¯è®¾ç½® (å…¨å±€)
http_client:
    connect_timeout: 5 # è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
    request_timeout: 10 # è¯·æ±‚è¶…æ—¶ï¼ˆç§’ï¼‰
    idle_timeout: 60 # ç©ºé—²è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰ (å¯é€‰)
    keepalive: 60 # TCP Keepaliveï¼ˆç§’ï¼‰ (å¯é€‰)
    agent: "LoadAnts/1.0" # è‡ªå®šä¹‰ User-Agent (å¯é€‰)

# ä¸Šæ¸¸ DoH æœåŠ¡å™¨ç»„
upstream_groups:
    - name: "google_public"
      strategy: "roundrobin" # å¯é€‰: roundrobin, weighted, random
      servers:
          - url: "https://dns.google/dns-query"
            method: "post" # å¯é€‰: get, post (é»˜è®¤ post)
            content_type: "message" # å¯é€‰: message, json (é»˜è®¤ message)
          - url: "https://8.8.4.4/dns-query"
            method: "get"
      retry: # å½“å‰ç»„çš„é‡è¯•ç­–ç•¥ (å¯é€‰)
          attempts: 3
          delay: 1 # ç§’
      proxy: "http://user:pass@proxyserver:port" # å½“å‰ç»„çš„ä»£ç† (å¯é€‰)

    - name: "cloudflare_secure"
      strategy: "random"
      servers:
          - url: "https://cloudflare-dns.com/dns-query"
          - url: "https://1.0.0.1/dns-query"
            content_type: "json"

    - name: "nextdns_authenticated"
      strategy: "weighted"
      servers:
          - url: "https://dns.nextdns.io/YOUR_CONFIG_ID_1"
            weight: 70
            auth: # ç‰¹å®šæœåŠ¡å™¨çš„è®¤è¯ (å¯é€‰)
                type: "bearer" # basic æˆ– bearer
                token: "YOUR_API_KEY_OR_TOKEN_1"
          - url: "https://dns.nextdns.io/YOUR_CONFIG_ID_2" # æ³¨æ„ï¼šé€šå¸¸ NextDNS ä½¿ç”¨ç›¸åŒçš„é…ç½®ID
            weight: 30
            auth:
                type: "basic"
                username: "your_username"
                password: "your_password"
      # retry: # è¿™ä¸ªç»„å¯ä»¥æœ‰è‡ªå·±çš„é‡è¯•ç­–ç•¥ (å¯é€‰)
      # proxy: # è¿™ä¸ªç»„ä¹Ÿå¯ä»¥æœ‰è‡ªå·±çš„ä»£ç† (å¯é€‰)

# è·¯ç”±è§„åˆ™ï¼ˆé™æ€é…ç½®ï¼‰
static_rules:
    # é˜»æ­¢ç‰¹å®šåŸŸå
    - match: "exact"
      patterns: ["ads.example.com", "tracker.example.org"]
      action: "block"

    # å°†å†…éƒ¨åŸŸåè·¯ç”±åˆ°ç‰¹å®šä¸Šæ¸¸ç»„
    - match: "wildcard"
      patterns: ["*.corp.internal", "*.mycompany.local"]
      action: "forward"
      target: "cloudflare_secure" # å¼•ç”¨ä¸Šé¢å®šä¹‰çš„ä¸Šæ¸¸ç»„åç§°

    # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å¹¶è½¬å‘
    - match: "regex"
      patterns: ["^(.*\.)?google\.com$", "^(.*\.)?gstatic\.com$"] # åŒ¹é… google.com åŠå…¶å­åŸŸå
      action: "forward"
      target: "google_public"

    # é»˜è®¤è§„åˆ™ï¼šå°†æ‰€æœ‰å…¶ä»–æµé‡è½¬å‘åˆ° google_public (ç¡®ä¿è¿™æ˜¯æœ€åä¸€æ¡è§„åˆ™)
    - match: "wildcard"
      patterns: ["*"] # åŒ¹é…æ‰€æœ‰åŸŸå
      action: "forward"
      target: "google_public"

# è¿œç¨‹è§„åˆ™é…ç½® (ä» URL åŠ è½½è§„åˆ™)
remote_rules:
  # ç¤ºä¾‹ï¼šä»URLåŠ è½½V2Rayæ ¼å¼çš„é˜»æ­¢åˆ—è¡¨
  - type: "url"
    url: "https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/reject-list.txt"
    format: "v2ray" # ç›®å‰æ”¯æŒ v2ray
    action: "block" # è§„åˆ™åˆ—è¡¨ä¸­çš„åŸŸåå°†è¢«é˜»æ­¢
    retry: # è·å–æ­¤è§„åˆ™åˆ—è¡¨çš„é‡è¯•ç­–ç•¥ (å¯é€‰)
      attempts: 3
      delay: 2
    proxy: "socks5://localhost:1080" # è·å–æ­¤è§„åˆ™åˆ—è¡¨æ—¶ä½¿ç”¨çš„ä»£ç† (å¯é€‰)
    auth: # è·å–æ­¤è§„åˆ™åˆ—è¡¨çš„è®¤è¯ (å¯é€‰)
      type: "bearer"
      token: "some_token"
    max_size: 2097152 # æ­¤è§„åˆ™æ–‡ä»¶çš„æœ€å¤§å¤§å° (ä¾‹å¦‚ 2MB)

  # ç¤ºä¾‹ï¼šä»URLåŠ è½½V2Rayæ ¼å¼çš„ä»£ç†(è½¬å‘)åˆ—è¡¨
  - type: "url"
    url: "https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/direct-list.txt" # é€šå¸¸ direct-list ç”¨äºç›´è¿ï¼Œè¿™é‡Œå‡è®¾ç”¨ä½œè½¬å‘
    format: "v2ray"
    action: "forward"
    target: "cloudflare_secure" # è§„åˆ™åˆ—è¡¨ä¸­çš„åŸŸåå°†è¢«è½¬å‘åˆ° cloudflare_secure ç»„
```

## å®‰è£…ä¸è¿›é˜¶ä½¿ç”¨

### å‘½ä»¤è¡Œå‚æ•°

```text
load-ants [OPTIONS]

é€‰é¡¹:
    -c, --config <PATH>    æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„
                           (é»˜è®¤æŸ¥æ‰¾é¡ºåº: ./config.yaml, /etc/load-ants/config.yaml)
    -t, --test             æµ‹è¯•é…ç½®æ–‡ä»¶æœ‰æ•ˆæ€§å¹¶é€€å‡º
    -h, --help             æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
    -V, --version          æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
```

### ä»æºä»£ç æ„å»º

å¦‚æœä½ å¸Œæœ›è‡ªè¡Œæ„å»ºæˆ–ä¿®æ”¹ä»£ç ï¼š

1.  **ç¯å¢ƒå‡†å¤‡**:

    -   å®‰è£… [Rust å·¥å…·é“¾](https://www.rust-lang.org/tools/install) (Rust 1.84.1, GCC 14.2.0)ã€‚
    -   ç¡®ä¿ä½ çš„ç³»ç»Ÿå·²å®‰è£… `git`ã€‚

2.  **å…‹éš†ä»£ç ä»“åº“**:

    ```bash
    git clone https://github.com/shengyanli1982/load-ants.git
    cd load-ants
    ```

    (è¯·å°† `shengyanli1982/load-ants.git` æ›¿æ¢ä¸ºå®é™…çš„ä»“åº“åœ°å€)

3.  **æ„å»ºåº”ç”¨ç¨‹åº**:

    ```bash
    cargo build --release
    ```

    ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ä½äº `target/release/load-ants`ã€‚

4.  **è¿è¡Œ**:
    ä½ éœ€è¦ä¸€ä¸ªé…ç½®æ–‡ä»¶ (ä¾‹å¦‚ï¼Œä» `config.default.yaml` å¤åˆ¶å¹¶ä¿®æ”¹)ã€‚
    ```bash
    # å‡è®¾é…ç½®æ–‡ä»¶åœ¨ ./config.yaml
    sudo ./target/release/load-ants -c ./config.yaml
    ```
    å¦‚æœéœ€è¦ç›‘å¬æ ‡å‡† DNS ç«¯å£ (53)ï¼Œé€šå¸¸éœ€è¦ `sudo` æƒé™ã€‚

ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¹Ÿå¯ä»¥ç›´æ¥ä»é¡¹ç›®çš„[å‘å¸ƒé¡µé¢](https://github.com/shengyanli1982/load-ants/releases)ä¸‹è½½ï¼ˆå¦‚æœæä¾›ï¼‰ã€‚

### ä½œä¸ºç³»ç»ŸæœåŠ¡ä½¿ç”¨ (Linux systemd)

å¦‚æœä½ å¸Œæœ›å°† Load Ants ä½œä¸ºåå°æœåŠ¡è¿è¡Œåœ¨ Linux ç³»ç»Ÿä¸Šï¼š

1.  **å‡†å¤‡äºŒè¿›åˆ¶æ–‡ä»¶å’Œé…ç½®æ–‡ä»¶**:

    -   å°†ç¼–è¯‘å¥½çš„ `load-ants` äºŒè¿›åˆ¶æ–‡ä»¶æ”¾ç½®åˆ°ä¸€ä¸ªåˆé€‚çš„ç³»ç»Ÿè·¯å¾„ï¼Œä¾‹å¦‚ `/usr/local/bin/load-ants`ã€‚
    -   å°†ä½ çš„é…ç½®æ–‡ä»¶æ”¾ç½®åˆ°ä¾‹å¦‚ `/etc/load-ants/config.yaml`ã€‚
        ```bash
        sudo mkdir -p /etc/load-ants
        sudo cp /path/to/your/config.yaml /etc/load-ants/config.yaml
        sudo cp ./target/release/load-ants /usr/local/bin/
        sudo chmod +x /usr/local/bin/load-ants
        ```

2.  **åˆ›å»ºæœåŠ¡æ–‡ä»¶**:
    åˆ›å»º `/etc/systemd/system/load-ants.service` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

    ```ini
    [Unit]
    Description=Load Ants DNS to DoH Proxy Service
    After=network.target network-online.target
    Requires=network-online.target

    [Service]
    Type=simple
    ExecStart=/usr/local/bin/load-ants -c /etc/load-ants/config.yaml
    Restart=on-failure
    RestartSec=5s
    User=root # æˆ–å…¶ä»–æœ‰æƒé™ç»‘å®š53ç«¯å£çš„ç”¨æˆ·ï¼Œå¦‚æœæ˜¯érootç”¨æˆ·ï¼Œå¯èƒ½éœ€è¦è®¾ç½®CAP_NET_BIND_SERVICE
    Group=root # æˆ–å¯¹åº”çš„ç”¨æˆ·ç»„
    # AmbientCapabilities=CAP_NET_BIND_SERVICE # å¦‚æœä»¥é root ç”¨æˆ·è¿è¡Œä¸”éœ€ç»‘å®šç‰¹æƒç«¯å£

    # å®‰å…¨æ€§å¢å¼º (å¯é€‰)
    ProtectSystem=full
    ProtectHome=true
    PrivateTmp=true
    NoNewPrivileges=true

    [Install]
    WantedBy=multi-user.target
    ```

3.  **é‡è½½ systemd é…ç½®å¹¶å¯åŠ¨æœåŠ¡**:

    ```bash
    sudo systemctl daemon-reload
    sudo systemctl enable load-ants.service
    sudo systemctl start load-ants.service
    ```

4.  **æ£€æŸ¥æœåŠ¡çŠ¶æ€**:
    ```bash
    sudo systemctl status load-ants.service
    journalctl -u load-ants.service -f # æŸ¥çœ‹å®æ—¶æ—¥å¿—
    ```

### Kubernetes éƒ¨ç½²æ–¹æ¡ˆ

å¯¹äºç”Ÿäº§ç¯å¢ƒï¼ŒKubernetes æä¾›äº†æ›´å¥½çš„æ‰©å±•æ€§ã€é«˜å¯ç”¨æ€§å’Œç®¡ç†ä¾¿æ·æ€§ã€‚

1.  **åˆ›å»º Docker é•œåƒ (å¦‚æœå°šæœªå‘å¸ƒ)**:
    å¦‚æœä½ çš„é¡¹ç›®åŒ…å« `Dockerfile`ï¼Œä½ éœ€è¦å…ˆæ„å»ºå¹¶æ¨é€ Docker é•œåƒåˆ°é•œåƒä»“åº“ (å¦‚ Docker Hub, GCR, ECR)ã€‚

    ```bash
    # å‡è®¾ Dockerfile åœ¨é¡¹ç›®æ ¹ç›®å½•
    docker build -t yourusername/load-ants:latest .
    docker push yourusername/load-ants:latest
    ```

    (è¯·å°† `yourusername/load-ants:latest` æ›¿æ¢ä¸ºä½ çš„å®é™…é•œåƒåç§°å’Œæ ‡ç­¾)

2.  **åˆ›å»º ConfigMap**:
    å°†ä½ çš„ `config.yaml` å†…å®¹å­˜å‚¨åœ¨ Kubernetes ConfigMap ä¸­ã€‚

    ```yaml
    # load-ants-configmap.yaml
    apiVersion: v1
    kind: ConfigMap
    metadata:
        name: load-ants-config
        namespace: dns # å»ºè®®ä¸ºDNSç›¸å…³æœåŠ¡ä½¿ç”¨ç‹¬ç«‹çš„å‘½åç©ºé—´
    data:
        config.yaml: |
            # åœ¨è¿™é‡Œç²˜è´´ä½ çš„å®Œæ•´ config.yaml å†…å®¹
            server:
              listen_udp: "0.0.0.0:53"
              listen_tcp: "0.0.0.0:53"
              listen_http: "0.0.0.0:80"
            admin:
              listen: "0.0.0.0:8080"
            cache:
              enabled: true
              max_size: 10000
              # ... å…¶ä»–é…ç½® ...
            upstream_groups:
              - name: "google_public"
                strategy: "roundrobin"
                servers:
                  - url: "https://dns.google/dns-query"
                # ... æ›´å¤šä¸Šæ¸¸é…ç½® ...
            # ... æ›´å¤šè§„åˆ™é…ç½® ...
    ```

3.  **åˆ›å»º Deployment**:
    å®šä¹‰ Deployment æ¥ç®¡ç† Load Ants Podã€‚

    ```yaml
    # load-ants-deployment.yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
        name: load-ants
        namespace: dns
        labels:
            app: load-ants
    spec:
        replicas: 2 # æ ¹æ®éœ€æ±‚è°ƒæ•´å‰¯æœ¬æ•°
        selector:
            matchLabels:
                app: load-ants
        template:
            metadata:
                labels:
                    app: load-ants
            spec:
                containers:
                    - name: load-ants
                      image: ghcr.io/shengyanli1982/load-ants-x64:latest # ä½¿ç”¨å®˜æ–¹æˆ–ä½ è‡ªå·±æ„å»ºçš„é•œåƒ
                      args: ["-c", "/etc/load-ants/config.yaml"]
                      ports:
                          - containerPort: 53
                            name: dns-udp
                            protocol: UDP
                          - containerPort: 53
                            name: dns-tcp
                            protocol: TCP
                          - containerPort: 8080
                            name: http-admin # ç”¨äºå¥åº·æ£€æŸ¥å’ŒæŒ‡æ ‡
                      volumeMounts:
                          - name: config-volume
                            mountPath: /etc/load-ants # æŒ‚è½½é…ç½®æ–‡ä»¶ç›®å½•
                      resources: # æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´èµ„æºè¯·æ±‚å’Œé™åˆ¶
                          limits:
                              memory: "256Mi"
                              cpu: "500m"
                          requests:
                              memory: "128Mi"
                              cpu: "100m"
                      livenessProbe: # å¥åº·æ£€æŸ¥
                          httpGet:
                              path: /health
                              port: http-admin
                          initialDelaySeconds: 15
                          periodSeconds: 20
                      readinessProbe: # å°±ç»ªæ¢é’ˆ
                          httpGet:
                              path: /health
                              port: http-admin
                          initialDelaySeconds: 5
                          periodSeconds: 10
                volumes:
                    - name: config-volume
                      configMap:
                          name: load-ants-config # å¼•ç”¨ä¸Šé¢åˆ›å»ºçš„ ConfigMap
    ```

4.  **åˆ›å»º Service**:
    æš´éœ² Load Ants æœåŠ¡ï¼Œä½¿å…¶å¯ä»¥åœ¨é›†ç¾¤å†…éƒ¨æˆ–å¤–éƒ¨è®¿é—®ã€‚

    ```yaml
    # load-ants-service.yaml
    apiVersion: v1
    kind: Service
    metadata:
        name: load-ants-svc
        namespace: dns
    spec:
        selector:
            app: load-ants # åŒ¹é… Deployment ä¸­çš„ Pod æ ‡ç­¾
        ports:
            - name: dns-udp
              port: 53
              protocol: UDP
              targetPort: dns-udp
            - name: dns-tcp
              port: 53
              protocol: TCP
              targetPort: dns-tcp
            - name: http-admin
              port: 8080
              protocol: TCP
              targetPort: http-admin
        # type: ClusterIP # é»˜è®¤ï¼Œä»…é›†ç¾¤å†…éƒ¨è®¿é—®ã€‚é›†ç¾¤å†…éƒ¨å…¶ä»–Podå¯é€šè¿‡ load-ants-svc.dns:53 è®¿é—®ã€‚
        type: LoadBalancer # å¦‚æœéœ€è¦ä»å¤–éƒ¨è®¿é—®ï¼Œå¹¶ç”±äº‘æä¾›å•†æ”¯æŒ (ä¼šåˆ†é…å…¬ç½‘IP)ã€‚
        # type: NodePort # å¦‚æœéœ€è¦åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„ç‰¹å®šç«¯å£ä¸Šæš´éœ²æœåŠ¡ã€‚
    ```

5.  **åº”ç”¨é…ç½®åˆ°é›†ç¾¤**:

    ```bash
    kubectl create namespace dns # å¦‚æœå°šæœªåˆ›å»º
    kubectl apply -f load-ants-configmap.yaml
    kubectl apply -f load-ants-deployment.yaml
    kubectl apply -f load-ants-service.yaml
    ```

6.  **æ£€æŸ¥éƒ¨ç½²çŠ¶æ€**:
    ```bash
    kubectl -n dns get pods -l app=load-ants
    kubectl -n dns get svc load-ants-svc
    kubectl -n dns logs -l app=load-ants -f # æŸ¥çœ‹ Pod å®æ—¶æ—¥å¿—
    ```

## æ·±å…¥äº†è§£

### æ¶æ„è®¾è®¡

Load Ants é‡‡ç”¨æ¨¡å—åŒ–æ¶æ„è®¾è®¡ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

-   **æœåŠ¡å™¨æ¨¡å— (`server`)**: ç›‘å¬ UDP/53 å’Œ TCP/53 ç«¯å£ï¼Œæ¥æ”¶ä¼ ç»Ÿçš„ DNS æŸ¥è¯¢ã€‚
-   **DNS è§£æå™¨ (`parser` & `composer`)**: è§£æä¼ å…¥çš„ DNS è¯·æ±‚ï¼Œæ„å»º DNS å“åº”ã€‚
-   **å¤„ç†å™¨æ¨¡å— (`processor`)**: åè°ƒæŸ¥è¯¢å¤„ç†æµç¨‹ï¼ŒåŒ…æ‹¬ç¼“å­˜æ£€æŸ¥ã€è·¯ç”±å†³ç­–å’Œä¸Šæ¸¸è½¬å‘ã€‚
-   **ç¼“å­˜æ¨¡å— (`cache`)**: å®ç°é«˜æ•ˆçš„ DNS ç¼“å­˜ï¼ˆæ­£å‘å’Œè´Ÿå‘ï¼‰ï¼Œå‡å°‘å»¶è¿Ÿï¼Œé™ä½ä¸Šæ¸¸è´Ÿè½½ã€‚
-   **è·¯ç”±æ¨¡å— (`router`)**: æ ¹æ®é…ç½®çš„è§„åˆ™ï¼ˆé™æ€å’Œè¿œç¨‹ï¼‰åŒ¹é…åŸŸåï¼Œå†³å®šæŸ¥è¯¢çš„åŠ¨ä½œï¼ˆè½¬å‘æˆ–é˜»æ­¢ï¼‰å’Œç›®æ ‡ã€‚
-   **ä¸Šæ¸¸ç®¡ç†æ¨¡å— (`upstream`)**: ç®¡ç† DoH ä¸Šæ¸¸æœåŠ¡å™¨ç»„ï¼Œå¤„ç†ä¸ DoH æœåŠ¡å™¨çš„ HTTP(S) é€šä¿¡ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€è®¤è¯å’Œé‡è¯•é€»è¾‘ã€‚
-   **HTTP å®¢æˆ·ç«¯ (`http_client`)**: å…¨å±€å…±äº«çš„ HTTP å®¢æˆ·ç«¯ï¼Œç”¨äºä¸ä¸Šæ¸¸ DoH æœåŠ¡å™¨ä»¥åŠè¿œç¨‹è§„åˆ™ URL é€šä¿¡ã€‚
-   **è¿œç¨‹è§„åˆ™åŠ è½½å™¨ (`remote_rule`)**: è´Ÿè´£ä» URL è·å–ã€è§£æå’Œè½¬æ¢è¿œç¨‹è§„åˆ™åˆ—è¡¨ï¼Œæ”¯æŒé‡è¯•ã€ä»£ç†å’Œè®¤è¯ã€‚
-   **ç®¡ç†ä¸ç›‘æ§æ¨¡å— (`admin`/`health`/`metrics`)**: æä¾› HTTP ç«¯ç‚¹ç”¨äºå¥åº·æ£€æŸ¥ (`/health`)ã€Prometheus æŒ‡æ ‡ (`/metrics`) å’Œç¼“å­˜åˆ·æ–° (`/api/cache/refresh`)ã€‚

![architecture](./images/architecture.png)
_å›¾ï¼šLoad Ants æ¶æ„ç¤ºæ„å›¾_

### Prometheus ç›‘æ§æŒ‡æ ‡

Load Ants æä¾›å®Œæ•´çš„ Prometheus ç›‘æ§æŒ‡æ ‡ï¼Œç”¨äºå®æ—¶ç›‘æ§æœåŠ¡æ€§èƒ½ã€å¥åº·çŠ¶æ€å’Œè¿è¡Œæƒ…å†µã€‚è¿™äº›æŒ‡æ ‡é€šè¿‡ `/metrics` ç«¯ç‚¹æš´éœ² (é»˜è®¤ç›‘å¬åœ¨ `0.0.0.0:8080/metrics`ï¼Œå¯é€šè¿‡ `health.listen` é…ç½®ä¿®æ”¹)ï¼Œå¯è¢« Prometheus æˆ–å…¶ä»–å…¼å®¹çš„ç›‘æ§ç³»ç»Ÿé‡‡é›†ã€‚

![metrics](./images/metrics.png)
_å›¾ï¼šLoad Ants Prometheus æŒ‡æ ‡ç¤ºä¾‹ (Grafana ä»ªè¡¨ç›˜)_

#### ä¸»è¦æŒ‡æ ‡åˆ†ç±»ï¼š

-   **DNS è¯·æ±‚æŒ‡æ ‡**:
    -   `loadants_dns_requests_total`: å¤„ç†çš„ DNS è¯·æ±‚æ€»æ•° (æ ‡ç­¾: `protocol` (UDP/TCP))ã€‚
    -   `loadants_dns_request_duration_seconds`: DNS è¯·æ±‚å¤„ç†è€—æ—¶ç›´æ–¹å›¾ (æ ‡ç­¾: `protocol`, `query_type`)ã€‚
    -   `loadants_dns_request_errors_total`: DNS è¯·æ±‚å¤„ç†é”™è¯¯æ€»æ•° (æ ‡ç­¾: `error_type`)ã€‚
-   **ç¼“å­˜æŒ‡æ ‡**:
    -   `loadants_cache_entries`: å½“å‰ DNS ç¼“å­˜æ¡ç›®æ•°é‡ã€‚
    -   `loadants_cache_capacity`: DNS ç¼“å­˜çš„æœ€å¤§å®¹é‡ã€‚
    -   `loadants_cache_operations_total`: ç¼“å­˜æ“ä½œæ€»æ•° (æ ‡ç­¾: `operation` (hit, miss, insert, evict, expire))ã€‚
    -   `loadants_cache_ttl_seconds`: DNS ç¼“å­˜æ¡ç›®çš„ TTL åˆ†å¸ƒç›´æ–¹å›¾ (æ ‡ç­¾: `source`)ã€‚
-   **DNS æŸ¥è¯¢è¯¦æƒ…**:
    -   `loadants_dns_query_type_total`: æŒ‰è®°å½•ç±»å‹ (A, AAAA, MX ç­‰) ç»Ÿè®¡çš„ DNS æŸ¥è¯¢æ€»æ•° (æ ‡ç­¾: `type`)ã€‚
    -   `loadants_dns_response_codes_total`: æŒ‰å“åº”ä»£ç  (RCODE) ç»Ÿè®¡çš„ DNS å“åº”æ€»æ•° (æ ‡ç­¾: `rcode`)ã€‚
-   **ä¸Šæ¸¸è§£æå™¨æŒ‡æ ‡**:
    -   `loadants_upstream_requests_total`: å‘é€åˆ°ä¸Šæ¸¸ DoH è§£æå™¨çš„è¯·æ±‚æ€»æ•° (æ ‡ç­¾: `group`, `server`)ã€‚
    -   `loadants_upstream_errors_total`: ä¸Šæ¸¸ DoH è§£æå™¨é”™è¯¯æ€»æ•° (æ ‡ç­¾: `error_type`, `group`, `server`)ã€‚
    -   `loadants_upstream_duration_seconds`: ä¸Šæ¸¸ DoH æŸ¥è¯¢è€—æ—¶ç›´æ–¹å›¾ (æ ‡ç­¾: `group`, `server`)ã€‚
-   **è·¯ç”±æŒ‡æ ‡**:
    -   `loadants_route_matches_total`: è·¯ç”±è§„åˆ™åŒ¹é…æ€»æ•° (æ ‡ç­¾: `rule_type` (exact, wildcard, regex), `target_group`, `rule_source` (static, remote), `action` (block, forward))ã€‚
    -   `loadants_route_rules_count`: å½“å‰æ´»è·ƒè·¯ç”±è§„åˆ™æ•°é‡ (æ ‡ç­¾: `rule_type`, `rule_source`)ã€‚

è¿™äº›ä¸°å¯Œçš„æŒ‡æ ‡æ”¯æŒå¯¹ Load Ants æ€§èƒ½å’Œè¡Œä¸ºè¿›è¡Œç²¾ç»†åŒ–ç›‘æ§å’Œåˆ†æï¼Œæœ‰åŠ©äºå¿«é€Ÿè¯†åˆ«é—®é¢˜ã€ä¼˜åŒ–é…ç½®å¹¶ç¡®ä¿æœåŠ¡æ»¡è¶³æ€§èƒ½éœ€æ±‚ã€‚

### API ç«¯ç‚¹

Load Ants æä¾›ä»¥ä¸‹ HTTP API ç«¯ç‚¹ï¼š

#### DNS æœåŠ¡ç«¯ç‚¹

-   **UDP å’Œ TCP ç«¯å£ 53** (æˆ–å…¶ä»–é€šè¿‡ `server.listen_udp` å’Œ `server.listen_tcp` é…ç½®çš„ç«¯å£)
    -   _æè¿°_: æ¥æ”¶ä¼ ç»Ÿ DNS æŸ¥è¯¢çš„æ ‡å‡† DNS ç«¯å£ã€‚
    -   _åè®®_: DNS over UDP/TCP (RFC 1035)ã€‚
    -   _ç”¨é€”_: æ ‡å‡† DNS å®¢æˆ·ç«¯ã€åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿé€šè¿‡è¿™äº›ç«¯å£å‘é€æŸ¥è¯¢ã€‚

#### ç®¡ç†ç«¯ç‚¹

é»˜è®¤ç›‘å¬åœ¨ `0.0.0.0:8080` (å¯é€šè¿‡ `health.listen` é…ç½®ä¿®æ”¹)ã€‚

-   **GET /health**

    -   _æè¿°_: å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼Œç”¨äºæœåŠ¡ç›‘æ§å’Œ Kubernetes liveness/readiness æ¢é’ˆã€‚
    -   _è¿”å›_: æœåŠ¡å¥åº·æ—¶è¿”å› `200 OK` å’Œç®€å•çš„ JSON å“åº” `{"status":"healthy"}`ã€‚
    -   _ç”¨æ³•_: `curl http://localhost:8080/health`

-   **GET /metrics**

    -   _æè¿°_: Prometheus æŒ‡æ ‡ç«¯ç‚¹ï¼Œæš´éœ²æ€§èƒ½å’Œè¿è¡Œç»Ÿè®¡ä¿¡æ¯ã€‚
    -   _å†…å®¹ç±»å‹_: `text/plain; version=0.0.4; charset=utf-8`
    -   _ç”¨æ³•_: `curl http://localhost:8080/metrics`

-   **POST /api/cache/refresh**
    -   _æè¿°_: æ¸…ç©º DNS ç¼“å­˜çš„ç®¡ç†ç«¯ç‚¹ã€‚
    -   _è¿”å›_: è¡¨ç¤ºæˆåŠŸæˆ–é”™è¯¯çš„ JSON å“åº”ã€‚
        -   æˆåŠŸ: `200 OK` ä¸ `{"status":"success", "message":"DNS cache has been cleared"}`
        -   ç¼“å­˜æœªå¯ç”¨: `400 Bad Request` ä¸ `{"status":"error", "message":"Cache is not enabled"}`
        -   å…¶ä»–é”™è¯¯: `500 Internal Server Error` ä¸ `{"status":"error", "message":"Failed to clear cache"}`
    -   _ç”¨æ³•_: `curl -X POST http://localhost:8080/api/cache/refresh`

API ç«¯ç‚¹éµå¾ªæ ‡å‡† HTTP çŠ¶æ€ç ã€‚

### åº”ç”¨åœºæ™¯

Load Ants ç‰¹åˆ«é€‚åˆä»¥ä¸‹åº”ç”¨åœºæ™¯ï¼š

-   **ä¸ªäººç”¨æˆ·/å®¶åº­ç½‘ç»œ**:
    -   æå‡éšç§ï¼šå°†æ‰€æœ‰ DNS æŸ¥è¯¢é€šè¿‡ DoH åŠ å¯†ï¼Œé˜²æ­¢ ISP æˆ–ç½‘ç»œä¸­é—´äººçª¥æ¢ã€‚
    -   ç»•è¿‡å°é”ä¸å®¡æŸ¥ï¼šé€šè¿‡é€‰æ‹©åˆé€‚çš„ DoH æœåŠ¡å™¨ï¼Œè§„é¿åŸºäº DNS çš„ç½‘ç»œè®¿é—®é™åˆ¶ã€‚
    -   å¹¿å‘Šä¸è¿½è¸ªå™¨æ‹¦æˆªï¼šç»“åˆé™æ€è§„åˆ™å’Œè¿œç¨‹é˜»æ­¢åˆ—è¡¨ (å¦‚ä» `oisd.nl` æˆ–å…¶ä»–æ¥æºè·å–)ï¼Œæœ‰æ•ˆæ‹¦æˆªå¹¿å‘ŠåŸŸåå’Œè¿½è¸ªå™¨ã€‚
    -   è‡ªå®šä¹‰è§£æï¼šä¸ºç‰¹å®šåŸŸåæŒ‡å®šç‰¹å®šçš„ä¸Šæ¸¸è§£æå™¨ (ä¾‹å¦‚ï¼Œç‰¹å®šæœåŠ¡ä½¿ç”¨ç‰¹å®šçš„ DNS)ã€‚
-   **å¼€å‘è€…/æµ‹è¯•ç¯å¢ƒ**:
    -   æœ¬åœ° DoH è§£æï¼šæ–¹ä¾¿åœ°åœ¨æœ¬åœ°æµ‹è¯•éœ€è¦ DoH æ”¯æŒçš„åº”ç”¨ã€‚
    -   DNS è¡Œä¸ºåˆ†æï¼šé€šè¿‡æ—¥å¿—å’ŒæŒ‡æ ‡è§‚å¯Ÿåº”ç”¨çš„ DNS æŸ¥è¯¢è¡Œä¸ºã€‚
    -   çµæ´»è·¯ç”±æµ‹è¯•ï¼šå¿«é€Ÿæ­å»ºå’Œæµ‹è¯•å¤æ‚çš„ DNS è·¯ç”±ç­–ç•¥ï¼ŒåŒ…æ‹¬åŸºäºè¿œç¨‹åˆ—è¡¨çš„åŠ¨æ€æ›´æ–°ã€‚
-   **ä¼ä¸š/ç»„ç»‡å†…éƒ¨ç½‘ç»œ**:
    -   é›†ä¸­åŒ– DNS è§£æï¼šç»Ÿä¸€ç®¡ç†å†…éƒ¨ç½‘ç»œçš„ DNS æŸ¥è¯¢ï¼Œå¼ºåˆ¶åŠ å¯†ï¼Œæé«˜ç½‘ç»œå®‰å…¨åŸºçº¿ã€‚
    -   å®‰å…¨ç­–ç•¥å®æ–½ï¼šé€šè¿‡è§„åˆ™é˜»æ­¢æ¶æ„åŸŸåã€é’“é±¼ç½‘ç«™ã€C&C æœåŠ¡å™¨ç­‰ï¼Œå¯é›†æˆå¨èƒæƒ…æŠ¥æºã€‚
    -   å†…éƒ¨åŸŸåè§£æï¼šå°†å†…éƒ¨åŸŸåè§£æè¯·æ±‚è·¯ç”±åˆ°å†…éƒ¨ DNS æœåŠ¡å™¨ï¼ˆå¦‚æœå†…éƒ¨ DNS æ”¯æŒ DoHï¼Œæˆ–é€šè¿‡å¦ä¸€å±‚é DoH ä»£ç†ï¼‰ã€‚
    -   åˆè§„æ€§ï¼šè®°å½•å’Œå®¡è®¡ DNS æŸ¥è¯¢ï¼ˆéœ€è‡ªè¡Œé…ç½®æ—¥å¿—æ”¶é›†å’Œåˆ†æç³»ç»Ÿï¼ŒLoad Ants æä¾›ç»“æ„åŒ–æ—¥å¿—è¾“å‡ºï¼‰ã€‚
-   **äº‘åŸç”Ÿç¯å¢ƒ (Kubernetes, Docker Swarm)**:
    -   Sidecar ä»£ç†ï¼šä½œä¸º Sidecar å®¹å™¨ä¸ºé›†ç¾¤å†…çš„å…¶ä»–åº”ç”¨æä¾› DoH è§£æèƒ½åŠ›ï¼Œæ— éœ€ä¿®æ”¹åº”ç”¨æœ¬èº«ã€‚
    -   é›†ç¾¤ DNS æœåŠ¡ï¼šä½œä¸ºé›†ç¾¤èŒƒå›´çš„ DNS è§£æå™¨ï¼ˆé€šå¸¸ä¸ CoreDNS ç­‰ç»“åˆæˆ–ä½œä¸ºå…¶ä¸Šæ¸¸ï¼Œä»¥å¢å¼ºç‰¹å®šåŠŸèƒ½ï¼‰ã€‚
    -   é«˜æ€§èƒ½ DNS ç½‘å…³ï¼šä¸ºå¤§è§„æ¨¡åº”ç”¨æä¾›é«˜å¹¶å‘ã€ä½å»¶è¿Ÿçš„ DNS-to-DoH è½¬æ¢å’Œæ™ºèƒ½è·¯ç”±ã€‚

## å¼€æºè®¸å¯

[MIT è®¸å¯è¯](./LICENSE)

## è‡´è°¢

-   æ„Ÿè°¢æ‰€æœ‰ä¸º Load Ants é¡¹ç›®åšå‡ºè´¡çŒ®çš„å¼€å‘è€…ã€‚
-   æœ¬é¡¹ç›®çš„è®¾è®¡å’Œå®ç°å—åˆ°äº†ä¼—å¤šä¼˜ç§€çš„å¼€æº DNS å·¥å…·å’Œ DoH å®è·µçš„å¯å‘ã€‚
-   ç‰¹åˆ«æ„Ÿè°¢ Rust ç¤¾åŒºæä¾›çš„å¼ºå¤§å·¥å…·å’Œç”Ÿæ€ç³»ç»Ÿã€‚
