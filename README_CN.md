[English](./README.md) | ä¸­æ–‡

<div align="center">
    <h1>LOAD ANTS</h1>
    <h4>ğŸœğŸœğŸœ è½»é‡çº§ DNS è½¬å‘å™¨ï¼Œå®ç° UDP/TCP æŸ¥è¯¢åˆ° DoH çš„æ— ç¼è½¬æ¢</h4></br>
    <img src="./images/logo.png" alt="logo" width="600">
</div>

<p align="center">
  <a href="#é¡¹ç›®ä»‹ç»">ç®€ä»‹</a>
  |
  <a href="#æ ¸å¿ƒåŠŸèƒ½">æ ¸å¿ƒåŠŸèƒ½</a>
  |
  <a href="#æ¶æ„è®¾è®¡">æ¶æ„</a>
  |
  <a href="#prometheus-ç›‘æ§æŒ‡æ ‡">Prometheus æŒ‡æ ‡</a>
  |
  <a href="#api-ç«¯ç‚¹">API ç«¯ç‚¹</a>
  |
  <a href="#åº”ç”¨åœºæ™¯">åº”ç”¨åœºæ™¯</a>
  |
  <a href="#é…ç½®è¯¦è§£">é…ç½®</a>
  |
  <a href="#å®‰è£…éƒ¨ç½²">éƒ¨ç½²æŒ‡å—</a>
  |
  <a href="#ä½¿ç”¨æŒ‡å—">ä½¿ç”¨æŒ‡å—</a>
</p>

## é¡¹ç›®ä»‹ç»

**Load Ants** æ˜¯ä¸€æ¬¾é«˜æ€§èƒ½ã€å¤šåŠŸèƒ½çš„ DNS ä»£ç†æœåŠ¡ï¼Œèƒ½å¤Ÿå°†ä¼ ç»Ÿçš„ UDP/TCP DNS æŸ¥è¯¢è½¬æ¢ä¸º DNS-over-HTTPS (DoH)ã€‚å®ƒä½œä¸ºä½¿ç”¨æ ‡å‡† DNS åè®®çš„å®¢æˆ·ç«¯ä¸ç°ä»£å®‰å…¨ DoH æä¾›å•†ä¹‹é—´çš„æ¡¥æ¢ï¼Œæä¾›å¢å¼ºçš„éšç§ä¿æŠ¤ã€å®‰å…¨æ€§å’Œçµæ´»çš„è·¯ç”±åŠŸèƒ½ã€‚

### ä¸ºä»€ä¹ˆé€‰æ‹© DNS-over-HTTPSï¼Ÿ

ä¼ ç»Ÿ DNS æŸ¥è¯¢é‡‡ç”¨æ˜æ–‡ä¼ è¾“ï¼Œè¿™ä½¿æ‚¨çš„æµè§ˆå†å²å®¹æ˜“é­å—ç›‘æ§ã€åŠ«æŒæˆ–ç¯¡æ”¹ã€‚DoH é€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³è¿™äº›é—®é¢˜ï¼š

-   **DNS æµé‡åŠ å¯†** - é˜²æ­¢ç½‘ç»œä¸­é—´äººçª¥æ¢
-   **éšç§å¢å¼º** - éšè— DNS æŸ¥è¯¢å†…å®¹ï¼Œé¿å…è¢«è¿è¥å•†å’Œå…¶ä»–ç½‘ç»œè§‚å¯Ÿè€…æ•è·
-   **å®‰å…¨æ€§æå‡** - æœ‰æ•ˆé™ä½ DNS æŠ•æ¯’å’Œæ¬ºéª—æ”»å‡»çš„é£é™©
-   **çªç ´ç½‘ç»œé™åˆ¶** - å¸®åŠ©è§„é¿åŸºäº DNS çš„ç½‘ç»œå°é”æŠ€æœ¯

## æ ¸å¿ƒåŠŸèƒ½

-   ğŸ”„ **åè®®è½¬æ¢**

    -   æ— ç¼å°† UDP/53 å’Œ TCP/53 DNS è¯·æ±‚è½¬æ¢ä¸º DoH (RFC 8484)
    -   å…¨é¢æ”¯æŒ GET å’Œ POST HTTP æ–¹æ³•
    -   å¤„ç†å¤šç§å†…å®¹æ ¼å¼ï¼ŒåŒ…æ‹¬ `application/dns-message` å’Œ `application/dns-json`

-   ğŸ§  **æ™ºèƒ½è·¯ç”±**

    -   **çµæ´»åŒ¹é…** - æ ¹æ®åŸŸåæ¨¡å¼ç²¾å‡†è·¯ç”± DNS æŸ¥è¯¢ï¼š
        -   ç²¾ç¡®åŸŸååŒ¹é…
        -   é€šé…ç¬¦åŸŸååŒ¹é…ï¼ˆå¦‚ `*.example.com`ï¼‰
        -   æ­£åˆ™è¡¨è¾¾å¼åŸŸååŒ¹é…
    -   **è‡ªå®šä¹‰æ“ä½œ** - ä¸ºæ¯æ¬¡åŒ¹é…å®šä¹‰ç²¾ç¡®å¤„ç†æ–¹å¼ï¼š
        -   è½¬å‘è‡³ç‰¹å®šä¸Šæ¸¸ DoH ç»„
        -   æ‹¦æˆªæŸ¥è¯¢ï¼ˆè¿”å› NXDOMAINï¼‰

-   ğŸŒ **çµæ´»çš„ä¸Šæ¸¸ç®¡ç†**

    -   **åˆ†ç»„æœºåˆ¶** - å°† DoH æœåŠ¡å™¨ç»„ç»‡æˆç‹¬ç«‹é…ç½®çš„é€»è¾‘ç»„
    -   **è´Ÿè½½å‡è¡¡** - ä¸ºæ¯ä¸ªç»„é…ç½®é«˜æ•ˆå‡è¡¡ç­–ç•¥ï¼š
        -   è½®è¯¢ (RR) - åœ¨æœåŠ¡å™¨ä¹‹é—´å‡è¡¡åˆ†é…è¯·æ±‚
        -   åŠ æƒè½®è¯¢ (WRR) - æ ¹æ®æƒé‡ä¼˜å…ˆè°ƒåº¦æœåŠ¡å™¨
        -   éšæœºåˆ†é… - éç¡®å®šæ€§é€‰æ‹©ï¼Œå¢å¼ºéšç§ä¿æŠ¤
    -   **è®¤è¯æ”¯æŒ** - ä¸éœ€è¦è®¤è¯çš„ç§æœ‰ DoH æä¾›å•†å®‰å…¨é€šä¿¡ï¼š
        -   HTTP åŸºæœ¬è®¤è¯
        -   Bearer ä»¤ç‰Œè®¤è¯
    -   **èµ„æºä¼˜åŒ–** - æ‰€æœ‰ä¸Šæ¸¸ç»„å…±äº« HTTP å®¢æˆ·ç«¯è¿æ¥æ± ï¼Œæå‡èµ„æºåˆ©ç”¨ç‡

-   âš¡ **æ€§èƒ½ä¼˜åŒ–**

    -   **æ™ºèƒ½ç¼“å­˜** - å†…ç½® DNS ç¼“å­˜æœºåˆ¶ï¼Œæ˜¾è‘—é™ä½å»¶è¿Ÿå’Œä¸Šæ¸¸è´Ÿè½½
        -   **æ­£å‘ç¼“å­˜** - å­˜å‚¨æˆåŠŸçš„ DNS å“åº”ï¼ŒåŠ é€Ÿè§£æè¿‡ç¨‹
        -   **è´Ÿå‘ç¼“å­˜** - ç¼“å­˜é”™è¯¯å“åº”ï¼ˆNXDOMAINã€ServFail ç­‰ï¼‰ï¼Œé¿å…å¯¹ä¸å­˜åœ¨åŸŸåçš„é‡å¤æŸ¥è¯¢
        -   **å¯è°ƒæ•´ TTL** - ä¸ºæ­£å‘å’Œè´Ÿå‘ç¼“å­˜æ¡ç›®è®¾ç½®å·®å¼‚åŒ–çš„ç”Ÿå­˜æ—¶é—´
    -   **è¿æ¥æ± å¤ç”¨** - é«˜æ•ˆå¤ç”¨ HTTP è¿æ¥ï¼Œæå‡æ€§èƒ½
    -   **TTL ä¼˜åŒ–** - çµæ´»é…ç½®ç¼“å­˜å“åº”çš„æœ€å°å’Œæœ€å¤§ TTL å€¼

-   ğŸ” **é«˜å¯é æ€§**

    -   **æ™ºèƒ½é‡è¯•** - è‡ªåŠ¨é‡è¯•å¤±è´¥çš„ DoH è¯·æ±‚ï¼Œæ”¯æŒå¯é…ç½®çš„å°è¯•æ¬¡æ•°
    -   **è¶…æ—¶æ§åˆ¶** - ç²¾ç¡®è°ƒæ•´è¿æ¥å’Œè¯·æ±‚è¶…æ—¶å‚æ•°

-   âš™ï¸ **ç®¡ç†èƒ½åŠ›**
    -   **YAML é…ç½®** - ç®€æ´ã€æ˜“è¯»çš„é…ç½®æ–¹å¼
    -   **é…ç½®æ ¡éªŒ** - å¯åŠ¨æ—¶æˆ–æµ‹è¯•æ¨¡å¼ä¸‹è¿›è¡Œä¸¥æ ¼é…ç½®éªŒè¯
    -   **å¥åº·æ£€æŸ¥** - ä¸ºè¿ç»´å›¢é˜Ÿæä¾›å®Œæ•´çš„ç›‘æ§é›†æˆæ¥å£
    -   **Prometheus æŒ‡æ ‡** - é€šè¿‡ `/metrics` ç«¯ç‚¹æä¾›å…¨é¢çš„ç›‘æ§æŒ‡æ ‡

## æ¶æ„è®¾è®¡

Load Ants é‡‡ç”¨æ¨¡å—åŒ–æ¶æ„è®¾è®¡ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

-   **æœåŠ¡å™¨æ¨¡å—**ï¼šæ¥æ”¶ä¼ ç»Ÿ DNS æŸ¥è¯¢çš„ UDP/TCP ç›‘å¬å™¨
-   **è·¯ç”±æ¨¡å—**ï¼šå°†åŸŸåä¸è§„åˆ™è¿›è¡ŒåŒ¹é…ï¼Œç¡®å®šå¤„ç†ç­–ç•¥
-   **ä¸Šæ¸¸ç®¡ç†æ¨¡å—**ï¼šå¤„ç†ä¸ DoH æœåŠ¡å™¨çš„é€šä¿¡ï¼Œå®ç°è´Ÿè½½å‡è¡¡å’Œè®¤è¯
-   **ç¼“å­˜æ¨¡å—**ï¼šé«˜æ•ˆå­˜å‚¨ DNS å“åº”ï¼Œæå‡æ€§èƒ½å¹¶å‡è½»ä¸Šæ¸¸è´Ÿè½½
-   **å¤„ç†å™¨æ¨¡å—**ï¼šåè°ƒå„ç»„ä»¶ï¼Œå®Œæˆ DNS æŸ¥è¯¢çš„å…¨æµç¨‹å¤„ç†

![architecture](./images/architecture.png)

## Prometheus ç›‘æ§æŒ‡æ ‡

Load Ants æä¾›å®Œæ•´çš„ Prometheus ç›‘æ§æŒ‡æ ‡ï¼Œç”¨äºå®æ—¶ç›‘æ§æœåŠ¡æ€§èƒ½ã€å¥åº·çŠ¶æ€å’Œè¿è¡Œæƒ…å†µã€‚è¿™äº›æŒ‡æ ‡é€šè¿‡ `/metrics` ç«¯ç‚¹æš´éœ²ï¼Œå¯è¢« Prometheus æˆ–å…¶ä»–å…¼å®¹çš„ç›‘æ§ç³»ç»Ÿé‡‡é›†ã€‚

![metrics](./images/metrics.png)

### DNS æ€§èƒ½æŒ‡æ ‡

-   **loadants_dns_requests_total** (è®¡æ•°å™¨) - ä»£ç†å¤„ç†çš„ DNS è¯·æ±‚æ€»æ•°ï¼ŒæŒ‰åè®®(UDP/TCP)åˆ†ç±»
-   **loadants_dns_request_duration_seconds** (ç›´æ–¹å›¾) - DNS è¯·æ±‚å¤„ç†è€—æ—¶ï¼ˆç§’ï¼‰ï¼ŒæŒ‰åè®®å’ŒæŸ¥è¯¢ç±»å‹åˆ†ç±»
-   **loadants_dns_request_errors_total** (è®¡æ•°å™¨) - DNS è¯·æ±‚å¤„ç†é”™è¯¯æ€»æ•°ï¼ŒæŒ‰é”™è¯¯ç±»å‹åˆ†ç±»

### ç¼“å­˜æ•ˆç‡æŒ‡æ ‡

-   **loadants_cache_entries** (ä»ªè¡¨ç›˜) - å½“å‰ DNS ç¼“å­˜æ¡ç›®æ•°é‡
-   **loadants_cache_capacity** (ä»ªè¡¨ç›˜) - DNS ç¼“å­˜çš„æœ€å¤§å®¹é‡ä¸Šé™
-   **loadants_cache_operations_total** (è®¡æ•°å™¨) - ç¼“å­˜æ“ä½œæ€»æ•°ï¼ŒæŒ‰æ“ä½œç±»å‹åˆ†ç±»ï¼ˆå‘½ä¸­ã€æœªå‘½ä¸­ã€æ’å…¥ã€é©±é€ã€è¿‡æœŸï¼‰
-   **loadants_cache_ttl_seconds** (ç›´æ–¹å›¾) - DNS ç¼“å­˜æ¡ç›®çš„ TTL åˆ†å¸ƒï¼ˆç§’ï¼‰ï¼ŒæŒ‰ TTL æ¥æºåˆ†ç±»ï¼ˆåŸå§‹ã€æœ€å° TTLã€è°ƒæ•´åã€è´Ÿå‘ç¼“å­˜ TTLï¼‰
-   **loadants_negative_cache_hits_total** (è®¡æ•°å™¨) - è´Ÿå‘ç¼“å­˜å‘½ä¸­æ€»æ•°ï¼Œç”¨äºè·Ÿè¸ªè´Ÿå‘ç¼“å­˜çš„æ•ˆç‡

### DNS æŸ¥è¯¢æŒ‡æ ‡

-   **loadants_dns_query_type_total** (è®¡æ•°å™¨) - æŒ‰è®°å½•ç±»å‹(A, AAAA, MX ç­‰)ç»Ÿè®¡çš„ DNS æŸ¥è¯¢æ€»æ•°
-   **loadants_dns_response_codes_total** (è®¡æ•°å™¨) - æŒ‰å“åº”ä»£ç (RCODE)ç»Ÿè®¡çš„ DNS å“åº”æ€»æ•°

### ä¸Šæ¸¸è§£æå™¨æŒ‡æ ‡

-   **loadants_upstream_requests_total** (è®¡æ•°å™¨) - å‘é€åˆ°ä¸Šæ¸¸ DoH è§£æå™¨çš„è¯·æ±‚æ€»æ•°ï¼ŒæŒ‰ç»„å’ŒæœåŠ¡å™¨åˆ†ç±»
-   **loadants_upstream_errors_total** (è®¡æ•°å™¨) - ä¸Šæ¸¸ DoH è§£æå™¨é”™è¯¯æ€»æ•°ï¼ŒæŒ‰é”™è¯¯ç±»å‹ã€ç»„å’ŒæœåŠ¡å™¨åˆ†ç±»
-   **loadants_upstream_duration_seconds** (ç›´æ–¹å›¾) - ä¸Šæ¸¸ DoH æŸ¥è¯¢è€—æ—¶ï¼ˆç§’ï¼‰ï¼ŒæŒ‰ç»„å’ŒæœåŠ¡å™¨åˆ†ç±»

### DNS è·¯ç”±æŒ‡æ ‡

-   **loadants_route_matches_total** (è®¡æ•°å™¨) - è·¯ç”±è§„åˆ™åŒ¹é…æ€»æ•°ï¼ŒæŒ‰è§„åˆ™ç±»å‹ï¼ˆç²¾ç¡®ã€é€šé…ç¬¦ã€æ­£åˆ™è¡¨è¾¾å¼ï¼‰å’Œç›®æ ‡ç»„åˆ†ç±»
-   **loadants_route_rules_count** (ä»ªè¡¨ç›˜) - å½“å‰æ´»è·ƒè·¯ç”±è§„åˆ™æ•°é‡ï¼ŒæŒ‰è§„åˆ™ç±»å‹ï¼ˆç²¾ç¡®ã€é€šé…ç¬¦ã€æ­£åˆ™è¡¨è¾¾å¼ï¼‰åˆ†ç±»

è¿™äº›ä¸°å¯Œçš„æŒ‡æ ‡æ”¯æŒå¯¹ Load Ants æ€§èƒ½å’Œè¡Œä¸ºè¿›è¡Œç²¾ç»†åŒ–ç›‘æ§å’Œåˆ†æï¼Œæœ‰åŠ©äºå¿«é€Ÿè¯†åˆ«é—®é¢˜ã€ä¼˜åŒ–é…ç½®å¹¶ç¡®ä¿æœåŠ¡æ»¡è¶³æ€§èƒ½éœ€æ±‚ã€‚

## API ç«¯ç‚¹

Load Ants æä¾›ä»¥ä¸‹ HTTP API ç«¯ç‚¹ï¼Œç”¨äº DNS è§£æå’ŒæœåŠ¡ç›‘æ§ï¼š

### DNS ç«¯ç‚¹

-   **UDP å’Œ TCP ç«¯å£ 53**
    -   _æè¿°_: æ¥æ”¶ä¼ ç»Ÿ DNS æŸ¥è¯¢çš„æ ‡å‡† DNS ç«¯å£
    -   _åè®®_: DNS over UDP/TCP (RFC 1035)
    -   _ç”¨é€”_: ä½¿ç”¨æ ‡å‡† DNS è§£æçš„åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿé€šè¿‡è¿™äº›ç«¯å£å‘é€æŸ¥è¯¢

### ç›‘æ§å’Œå¥åº·æ£€æŸ¥ç«¯ç‚¹

-   **GET /health**

    -   _æè¿°_: ç”¨äºç›‘æ§æœåŠ¡å’Œ Kubernetes æ¢é’ˆçš„å¥åº·æ£€æŸ¥ç«¯ç‚¹
    -   _è¿”å›_: æœåŠ¡å¥åº·æ—¶è¿”å› 200 OK
    -   _ç”¨æ³•_: `curl http://localhost:8080/health`

-   **GET /metrics**

    -   _æè¿°_: æš´éœ²æ€§èƒ½å’Œè¿è¡Œç»Ÿè®¡ä¿¡æ¯çš„ Prometheus æŒ‡æ ‡ç«¯ç‚¹
    -   _å†…å®¹ç±»å‹_: text/plain
    -   _ç”¨æ³•_: `curl http://localhost:8080/metrics`

-   **POST /api/cache/refresh**
    -   _æè¿°_: æ¸…ç©º DNS ç¼“å­˜çš„ç®¡ç†ç«¯ç‚¹
    -   _è¿”å›_: è¡¨ç¤ºæˆåŠŸæˆ–é”™è¯¯çš„ JSON å“åº”
    -   _ç”¨æ³•_: `curl -X POST http://localhost:8080/api/cache/refresh`
    -   _å“åº”ç¤ºä¾‹_: `{"status":"success","message":"DNS cache has been cleared"}`

è¿™äº›ç«¯ç‚¹éµå¾ªæ ‡å‡† HTTP çŠ¶æ€ç ï¼š

-   200: æŸ¥è¯¢/æ“ä½œæˆåŠŸ
-   400: è¯·æ±‚é”™è¯¯ï¼ˆä¾‹å¦‚ï¼Œå½“ç¼“å­˜æœªå¯ç”¨æ—¶ï¼‰
-   500: å¤„ç†è¿‡ç¨‹ä¸­å‘ç”ŸæœåŠ¡å™¨é”™è¯¯

## åº”ç”¨åœºæ™¯

Load Ants ç‰¹åˆ«é€‚åˆä»¥ä¸‹åº”ç”¨åœºæ™¯ï¼š

-   **ä¼ä¸š/å†…éƒ¨ç½‘ç»œ**ï¼šé›†ä¸­åŒ– DNS è§£æï¼Œå¼ºåˆ¶æµé‡åŠ å¯†ï¼Œå®æ–½ç²¾ç»†çš„å†…éƒ¨åç§°è§£æç­–ç•¥
-   **ä¸ªäººç”¨æˆ·/å¼€å‘è€…**ï¼šç»•è¿‡è¿è¥å•† DNS åŠ«æŒ/æ±¡æŸ“ï¼Œæå‡éšç§ä¿æŠ¤ï¼Œç²¾ç¡®æ§åˆ¶ç‰¹å®šåŸŸåè§£æ
-   **äº‘åŸç”Ÿç¯å¢ƒ**ï¼šä½œä¸º sidecar æˆ–ç‹¬ç«‹æœåŠ¡ï¼Œæä¾›é«˜æ€§èƒ½çš„ DNS è§£æèƒ½åŠ›

## å®‰è£…éƒ¨ç½²

### ç¯å¢ƒè¦æ±‚

-   Rust å·¥å…·é“¾ï¼ˆä»æºä»£ç æ„å»ºæ—¶éœ€è¦ï¼‰
-   ç®¡ç†å‘˜/root æƒé™ï¼ˆç»‘å®š 53 ç«¯å£æ—¶éœ€è¦ï¼‰

### ä»æºä»£ç æ„å»º

1. å…‹éš†ä»£ç ä»“åº“ï¼š

    ```bash
    git clone https://github.com/yourusername/load-ants.git
    cd load-ants
    ```

2. æ„å»ºåº”ç”¨ç¨‹åºï¼š

    ```bash
    cargo build --release
    ```

3. ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¹Ÿå¯ä»¥ç›´æ¥ä»[å‘å¸ƒé¡µé¢](https://github.com/shengyanli1982/load-ants/releases)ä¸‹è½½ã€‚

### ä½¿ç”¨ Docker éƒ¨ç½²

Docker æä¾›äº†ä¸€ç§ç®€ä¾¿çš„æ–¹å¼æ¥è¿è¡Œ Load Antsï¼Œæ— éœ€åœ¨ç³»ç»Ÿä¸Šç›´æ¥å®‰è£… Rust æˆ–å…¶ä¾èµ–é¡¹ã€‚

1. åˆ›å»ºé…ç½®ç›®å½•ï¼š

    ```bash
    mkdir -p ./load-ants-config
    ```

2. å‡†å¤‡é…ç½®æ–‡ä»¶ï¼š

    ```bash
    cp config.default.yaml ./load-ants-config/config.yaml
    # ç¼–è¾‘é…ç½®æ–‡ä»¶ä»¥æ»¡è¶³æ‚¨çš„å®é™…éœ€æ±‚
    ```

3. ä»¥ Docker å®¹å™¨æ–¹å¼è¿è¡Œ Load Antsï¼š

    ```bash
    docker run -d \
      --name load-ants \
      -p 53:53/udp \
      -p 53:53/tcp \
      -p 8080:8080 \
      -v $(pwd)/load-ants-config:/etc/load-ants \
      yourusername/load-ants:latest -c /etc/load-ants/config.yaml
    ```

4. æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼š

    ```bash
    docker logs load-ants
    ```

5. åœæ­¢å’Œç§»é™¤å®¹å™¨ï¼š
    ```bash
    docker stop load-ants
    docker rm load-ants
    ```

### Kubernetes éƒ¨ç½²æ–¹æ¡ˆ

å¯¹äºç”Ÿäº§ç¯å¢ƒï¼ŒKubernetes æä¾›äº†æ›´å¥½çš„æ‰©å±•æ€§ã€é«˜å¯ç”¨æ€§å’Œç®¡ç†ä¾¿æ·æ€§ã€‚

1. åˆ›å»ºé…ç½® ConfigMapï¼š

    ```yaml
    # configmap.yaml
    apiVersion: v1
    kind: ConfigMap
    metadata:
        name: load-ants-config
        namespace: dns
    data:
        config.yaml: |
            server:
              listen_udp: "0.0.0.0:53"
              listen_tcp: "0.0.0.0:53"
            health:
              listen: "0.0.0.0:8080"
            cache:
              enabled: true
              max_size: 10000
              min_ttl: 60
              max_ttl: 3600
              negative_ttl: 300
            # æ·»åŠ å…¶ä»–å¿…è¦é…ç½®...
    ```

2. åˆ›å»º Deployment èµ„æºï¼š

    ```yaml
    # deployment.yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
        name: load-ants
        namespace: dns
        labels:
            app: load-ants
    spec:
        replicas: 2
        selector:
            matchLabels:
                app: load-ants
        template:
            metadata:
                labels:
                    app: load-ants
            spec:
                containers:
                    - name: load-ants
                      image: yourusername/load-ants:latest
                      args: ["-c", "/etc/load-ants/config.yaml"]
                      ports:
                          - containerPort: 53
                            name: dns-udp
                            protocol: UDP
                          - containerPort: 53
                            name: dns-tcp
                            protocol: TCP
                          - containerPort: 8080
                            name: health
                      volumeMounts:
                          - name: config-volume
                            mountPath: /etc/load-ants
                      resources:
                          limits:
                              memory: "256Mi"
                              cpu: "500m"
                          requests:
                              memory: "128Mi"
                              cpu: "100m"
                      livenessProbe:
                          httpGet:
                              path: /health
                              port: 8080
                          initialDelaySeconds: 5
                          periodSeconds: 10
                volumes:
                    - name: config-volume
                      configMap:
                          name: load-ants-config
    ```

3. åˆ›å»º Service èµ„æºï¼š

    ```yaml
    # service.yaml
    apiVersion: v1
    kind: Service
    metadata:
        name: load-ants
        namespace: dns
    spec:
        selector:
            app: load-ants
        ports:
            - port: 53
              name: dns-udp
              protocol: UDP
              targetPort: 53
            - port: 53
              name: dns-tcp
              protocol: TCP
              targetPort: 53
        type: ClusterIP
    ```

4. åº”ç”¨é…ç½®åˆ°é›†ç¾¤ï¼š

    ```bash
    kubectl create namespace dns
    kubectl apply -f configmap.yaml
    kubectl apply -f deployment.yaml
    kubectl apply -f service.yaml
    ```

5. æ£€æŸ¥éƒ¨ç½²çŠ¶æ€ï¼š
    ```bash
    kubectl -n dns get pods
    kubectl -n dns get svc
    ```

### ä½œä¸ºç³»ç»ŸæœåŠ¡ä½¿ç”¨

#### Linux (systemd)

1. åˆ›å»ºæœåŠ¡æ–‡ä»¶ `/etc/systemd/system/load-ants.service`ï¼š

    ```ini
    [Unit]
    Description=Load Ants DNS to DoH ä»£ç†æœåŠ¡
    After=network.target

    [Service]
    ExecStart=/path/to/load-ants -c /etc/load-ants/config.yaml
    Restart=on-failure
    User=root

    [Install]
    WantedBy=multi-user.target
    ```

2. åˆ›å»ºé…ç½®ç›®å½•å’Œæ–‡ä»¶ï¼š

    ```bash
    mkdir -p /etc/load-ants
    cp config.default.yaml /etc/load-ants/config.yaml
    # æ ¹æ®å®é™…éœ€æ±‚ç¼–è¾‘é…ç½®æ–‡ä»¶
    ```

3. å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡ï¼š
    ```bash
    systemctl enable load-ants
    systemctl start load-ants
    ```

## ä½¿ç”¨æŒ‡å—

### å‘½ä»¤è¡Œå‚æ•°

```
load-ants [OPTIONS]

é€‰é¡¹:
    -c, --config <PATH>    æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆé»˜è®¤ï¼š./config.yamlï¼‰
    -t, --test             æµ‹è¯•é…ç½®æ–‡ä»¶æœ‰æ•ˆæ€§å¹¶é€€å‡º
    -h, --help             æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
    -V, --version          æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
```

### ä½¿ç”¨ç¤ºä¾‹

1. åŸºäºé»˜è®¤æ¨¡æ¿åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š

    ```bash
    cp config.default.yaml config.yaml
    ```

2. æ ¹æ®å®é™…éœ€æ±‚ç¼–è¾‘é…ç½®æ–‡ä»¶

3. å¯åŠ¨ Load Ants æœåŠ¡ï¼š

    ```bash
    sudo ./load-ants -c config.yaml
    ```

4. æµ‹è¯•æœåŠ¡æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š
    ```bash
    dig @127.0.0.1 example.com
    ```

## é…ç½®è¯¦è§£

Load Ants ä½¿ç”¨ YAML æ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´çš„é…ç½®é€‰é¡¹å‚è€ƒï¼š

### æœåŠ¡å™¨é…ç½® (server)

| å‚æ•°        | ç±»å‹   | é»˜è®¤å€¼         | æè¿°                   | æœ‰æ•ˆèŒƒå›´            |
| ----------- | ------ | -------------- | ---------------------- | ------------------- |
| listen_udp  | å­—ç¬¦ä¸² | "127.0.0.1:53" | UDP DNS ç›‘å¬åœ°å€å’Œç«¯å£ | æœ‰æ•ˆçš„ IP:ç«¯å£ æ ¼å¼ |
| listen_tcp  | å­—ç¬¦ä¸² | "127.0.0.1:53" | TCP DNS ç›‘å¬åœ°å€å’Œç«¯å£ | æœ‰æ•ˆçš„ IP:ç«¯å£ æ ¼å¼ |
| tcp_timeout | æ•´æ•°   | 10             | TCP è¿æ¥ç©ºé—²è¶…æ—¶ï¼ˆç§’ï¼‰ | -                   |

### å¥åº·æ£€æŸ¥é…ç½® (health)

| å‚æ•°   | ç±»å‹   | é»˜è®¤å€¼           | æè¿°                       | æœ‰æ•ˆèŒƒå›´            |
| ------ | ------ | ---------------- | -------------------------- | ------------------- |
| listen | å­—ç¬¦ä¸² | "127.0.0.1:8080" | å¥åº·æ£€æŸ¥æœåŠ¡ç›‘å¬åœ°å€å’Œç«¯å£ | æœ‰æ•ˆçš„ IP:ç«¯å£ æ ¼å¼ |

### ç¼“å­˜é…ç½® (cache)

| å‚æ•°         | ç±»å‹   | é»˜è®¤å€¼ | æè¿°               | æœ‰æ•ˆèŒƒå›´   |
| ------------ | ------ | ------ | ------------------ | ---------- |
| enabled      | å¸ƒå°”å€¼ | true   | æ˜¯å¦å¯ç”¨ç¼“å­˜       | true/false |
| max_size     | æ•´æ•°   | 10000  | æœ€å¤§ç¼“å­˜æ¡ç›®æ•°     | 10-1000000 |
| min_ttl      | æ•´æ•°   | 60     | æœ€å° TTLï¼ˆç§’ï¼‰     | 1-86400    |
| max_ttl      | æ•´æ•°   | 3600   | æœ€å¤§ TTLï¼ˆç§’ï¼‰     | 1-86400    |
| negative_ttl | æ•´æ•°   | 300    | è´Ÿå‘ç¼“å­˜ TTLï¼ˆç§’ï¼‰ | 1-86400    |

ç¼“å­˜é…ç½®å…è®¸ç²¾ç»†è°ƒæ•´ DNS å“åº”çš„ç¼“å­˜è¡Œä¸ºï¼š

-   **enabled**ï¼šæ§åˆ¶ç¼“å­˜åŠŸèƒ½çš„å¼€å…³
-   **max_size**ï¼šç¼“å­˜ä¸­å¯å­˜å‚¨çš„ DNS è®°å½•æœ€å¤§æ•°é‡
-   **min_ttl**ï¼šæ­£å‘å“åº”çš„æœ€å°ç”Ÿå­˜æ—¶é—´ï¼ˆä¼šè¦†ç›–åŸå§‹å“åº”ä¸­æ›´å°çš„ TTL å€¼ï¼‰
-   **max_ttl**ï¼šæ‰€æœ‰ç¼“å­˜æ¡ç›®çš„æœ€å¤§ç”Ÿå­˜æ—¶é—´ä¸Šé™
-   **negative_ttl**ï¼šè´Ÿå‘å“åº”ï¼ˆå¦‚é”™è¯¯ã€ä¸å­˜åœ¨åŸŸåï¼‰çš„ç‰¹å®šç”Ÿå­˜æ—¶é—´

è´Ÿå‘ç¼“å­˜æ˜¯ä¸€ç§é‡è¦çš„æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ï¼Œå®ƒå°† DNS é”™è¯¯å“åº”ï¼ˆå¦‚ NXDOMAIN æˆ– ServFailï¼‰ç¼“å­˜æŒ‡å®šæ—¶é—´ã€‚è¿™èƒ½æœ‰æ•ˆé˜²æ­¢å¯¹ä¸å­˜åœ¨æˆ–æš‚æ—¶æ— æ³•è§£æçš„åŸŸåé‡å¤æŸ¥è¯¢ä¸Šæ¸¸æœåŠ¡å™¨ï¼Œä»è€Œå‡å°‘å»¶è¿Ÿå¹¶é™ä½ä¸Šæ¸¸æœåŠ¡å™¨è´Ÿè½½ã€‚

### HTTP å®¢æˆ·ç«¯é…ç½® (http_client)

| å‚æ•°            | ç±»å‹   | é»˜è®¤å€¼ | æè¿°                        | æœ‰æ•ˆèŒƒå›´   |
| --------------- | ------ | ------ | --------------------------- | ---------- |
| connect_timeout | æ•´æ•°   | 5      | è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰              | 1-120      |
| request_timeout | æ•´æ•°   | 10     | è¯·æ±‚è¶…æ—¶ï¼ˆç§’ï¼‰              | 1-1200     |
| idle_timeout    | æ•´æ•°   | 60     | ç©ºé—²è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰ï¼ˆå¯é€‰ï¼‰  | 5-1800     |
| keepalive       | æ•´æ•°   | 60     | TCP Keepaliveï¼ˆç§’ï¼‰ï¼ˆå¯é€‰ï¼‰ | 5-600      |
| agent           | å­—ç¬¦ä¸² | -      | HTTP ç”¨æˆ·ä»£ç†ï¼ˆå¯é€‰ï¼‰       | éç©ºå­—ç¬¦ä¸² |

### ä¸Šæ¸¸ DoH æœåŠ¡å™¨ç»„é…ç½® (upstream_groups)

| å‚æ•°     | ç±»å‹   | é»˜è®¤å€¼ | æè¿°                     | æœ‰æ•ˆèŒƒå›´                           |
| -------- | ------ | ------ | ------------------------ | ---------------------------------- |
| name     | å­—ç¬¦ä¸² | -      | ç»„åç§°                   | éç©ºå­—ç¬¦ä¸²                         |
| strategy | å­—ç¬¦ä¸² | -      | è´Ÿè½½å‡è¡¡ç­–ç•¥             | "roundrobin", "weighted", "random" |
| servers  | æ•°ç»„   | -      | æœåŠ¡å™¨åˆ—è¡¨               | è‡³å°‘åŒ…å«ä¸€ä¸ªæœåŠ¡å™¨                 |
| retry    | å¯¹è±¡   | -      | é‡è¯•é…ç½®ï¼ˆå¯é€‰ï¼‰         | -                                  |
| proxy    | å­—ç¬¦ä¸² | -      | HTTP/SOCKS5 ä»£ç†ï¼ˆå¯é€‰ï¼‰ | æœ‰æ•ˆçš„ä»£ç† URL                     |

#### æœåŠ¡å™¨é…ç½® (servers)

| å‚æ•°         | ç±»å‹   | é»˜è®¤å€¼    | æè¿°                   | æœ‰æ•ˆèŒƒå›´                     |
| ------------ | ------ | --------- | ---------------------- | ---------------------------- |
| url          | å­—ç¬¦ä¸² | -         | DoH æœåŠ¡å™¨ URL         | æœ‰æ•ˆçš„ HTTP(S) URLï¼ŒåŒ…å«è·¯å¾„ |
| weight       | æ•´æ•°   | 1         | æƒé‡ï¼ˆä»…ç”¨äºåŠ æƒç­–ç•¥ï¼‰ | 1-65535                      |
| method       | å­—ç¬¦ä¸² | "post"    | DoH è¯·æ±‚æ–¹æ³•           | "get", "post"                |
| content_type | å­—ç¬¦ä¸² | "message" | DoH å†…å®¹ç±»å‹           | "message", "json"            |
| auth         | å¯¹è±¡   | -         | è®¤è¯é…ç½®ï¼ˆå¯é€‰ï¼‰       | -                            |

#### è®¤è¯é…ç½® (auth)

| å‚æ•°     | ç±»å‹   | é»˜è®¤å€¼ | æè¿°                        | æœ‰æ•ˆèŒƒå›´          |
| -------- | ------ | ------ | --------------------------- | ----------------- |
| type     | å­—ç¬¦ä¸² | -      | è®¤è¯ç±»å‹                    | "basic", "bearer" |
| username | å­—ç¬¦ä¸² | -      | ç”¨æˆ·åï¼ˆä»…ç”¨äº basic è®¤è¯ï¼‰ | éç©ºå­—ç¬¦ä¸²        |
| password | å­—ç¬¦ä¸² | -      | å¯†ç ï¼ˆä»…ç”¨äº basic è®¤è¯ï¼‰   | éç©ºå­—ç¬¦ä¸²        |
| token    | å­—ç¬¦ä¸² | -      | ä»¤ç‰Œï¼ˆä»…ç”¨äº bearer è®¤è¯ï¼‰  | éç©ºå­—ç¬¦ä¸²        |

#### é‡è¯•é…ç½® (retry)

| å‚æ•°     | ç±»å‹ | é»˜è®¤å€¼ | æè¿°           | æœ‰æ•ˆèŒƒå›´ |
| -------- | ---- | ------ | -------------- | -------- |
| attempts | æ•´æ•° | -      | é‡è¯•æ¬¡æ•°       | 1-100    |
| delay    | æ•´æ•° | -      | åˆå§‹å»¶è¿Ÿï¼ˆç§’ï¼‰ | 1-120    |

### è·¯ç”±è§„åˆ™é…ç½® (routing_rules)

| å‚æ•°     | ç±»å‹   | é»˜è®¤å€¼ | æè¿°                                          | æœ‰æ•ˆèŒƒå›´                     |
| -------- | ------ | ------ | --------------------------------------------- | ---------------------------- |
| match    | å­—ç¬¦ä¸² | -      | åŒ¹é…ç±»å‹                                      | "exact", "wildcard", "regex" |
| patterns | æ•°ç»„   | -      | åŒ¹é…æ¨¡å¼                                      | éç©ºå­—ç¬¦ä¸²æ•°ç»„               |
| action   | å­—ç¬¦ä¸² | -      | è·¯ç”±åŠ¨ä½œ                                      | "forward", "block"           |
| target   | å­—ç¬¦ä¸² | -      | ç›®æ ‡ä¸Šæ¸¸ç»„ï¼ˆå½“ action ä¸º forward æ—¶å¿…é¡»æä¾›ï¼‰ | å·²å®šä¹‰çš„ä¸Šæ¸¸ç»„åç§°           |

Load Ants é‡‡ç”¨åŸºäºä¼˜å…ˆçº§çš„åŒ¹é…ç³»ç»Ÿè¿›è¡Œ DNS è·¯ç”±å†³ç­–ï¼š

1. **ç²¾ç¡®åŒ¹é…**ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰- å®Œå…¨åŒ¹é…å®Œæ•´åŸŸåï¼ˆå¦‚ `example.com`ï¼‰
2. **ç‰¹å®šé€šé…ç¬¦åŒ¹é…** - ä½¿ç”¨é€šé…ç¬¦åŒ¹é…ç‰¹å®šåŸŸåæ¨¡å¼ï¼ˆå¦‚ `*.example.com`ï¼‰
3. **æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…** - ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œå¤æ‚åŒ¹é…ï¼ˆå¦‚ `^(mail|audio)\\.google\\.com$`ï¼‰
4. **å…¨å±€é€šé…ç¬¦åŒ¹é…**ï¼ˆæœ€ä½ä¼˜å…ˆçº§ï¼‰- ä½¿ç”¨é€šé…è§„åˆ™ï¼ˆ`*`ï¼‰åŒ¹é…ä»»ä½•åŸŸå

é…ç½®è·¯ç”±è§„åˆ™æ—¶ï¼Œåº”å……åˆ†è€ƒè™‘è¿™ä¸ªä¼˜å…ˆçº§é¡ºåºã€‚å…¨å±€é€šé…ç¬¦ï¼ˆ`*`ï¼‰é€šå¸¸åº”ä½œä¸ºæœ€åä¸€æ¡è§„åˆ™ï¼Œä½œä¸ºå…¶ä»–è§„åˆ™éƒ½ä¸åŒ¹é…æ—¶çš„é»˜è®¤é€‰é¡¹ã€‚

### é…ç½®ç¤ºä¾‹

```yaml
# Load Ants é…ç½®ç¤ºä¾‹

# æœåŠ¡å™¨ç›‘å¬è®¾ç½®
server:
    listen_udp: "0.0.0.0:53" # UDP ç›‘å¬åœ°å€å’Œç«¯å£
    listen_tcp: "0.0.0.0:53" # TCP ç›‘å¬åœ°å€å’Œç«¯å£

# å¥åº·æ£€æŸ¥æœåŠ¡å™¨è®¾ç½®
health:
    listen: "0.0.0.0:8080" # å¥åº·æ£€æŸ¥æœåŠ¡å™¨ç›‘å¬åœ°å€å’Œç«¯å£

# ç¼“å­˜è®¾ç½®
cache:
    enabled: true
    max_size: 10000 # æœ€å¤§ç¼“å­˜æ¡ç›®æ•°
    min_ttl: 60 # ç¼“å­˜æ¡ç›®æœ€å° TTLï¼ˆç§’ï¼‰
    max_ttl: 3600 # ç¼“å­˜æ¡ç›®æœ€å¤§ TTLï¼ˆç§’ï¼‰
    negative_ttl: 300 # è´Ÿé¢ç¼“å­˜ TTLï¼ˆç§’ï¼‰ï¼Œç”¨äºç¼“å­˜é”™è¯¯å“åº”

# HTTP å®¢æˆ·ç«¯è®¾ç½®
http_client:
    connect_timeout: 5 # è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
    request_timeout: 10 # è¯·æ±‚è¶…æ—¶ï¼ˆç§’ï¼‰
    idle_timeout: 60 # ç©ºé—²è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
    keepalive: 60 # TCP Keepaliveï¼ˆç§’ï¼‰
    agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"

# ä¸Šæ¸¸ DoH æœåŠ¡å™¨ç»„
upstream_groups:
    - name: "google_public"
      strategy: "roundrobin" # roundrobin, weighted, random
      servers:
          - url: "https://dns.google/dns-query"
          - url: "https://8.8.4.4/dns-query"
            method: "get"
            content_type: "message"
      retry:
          attempts: 3
          delay: 1
      proxy: "http://user:pass@proxyserver:port" # å¯é€‰çš„ä»£ç†

    - name: "cloudflare_secure"
      strategy: "random"
      servers:
          - url: "https://cloudflare-dns.com/dns-query"
            method: "post"
          - url: "https://1.0.0.1/dns-query"
            method: "get"
            content_type: "json"

    - name: "nextdns_weighted"
      strategy: "weighted"
      servers:
          - url: "https://dns.nextdns.io/YOUR_CONFIG_ID"
            weight: 70
            auth:
                type: "bearer"
                token: "YOUR_API_KEY_OR_TOKEN"
          - url: "https://dns2.nextdns.io/YOUR_CONFIG_ID"
            weight: 30
      retry:
          attempts: 2
          delay: 2

# è·¯ç”±è§„åˆ™ï¼ˆæŒ‰é¡ºåºå¤„ç†ï¼‰
routing_rules:
    # é˜»æ­¢ç‰¹å®šåŸŸå
    - match: "exact"
      patterns: ["ads.example.com", "ads2.example.com"] # æ”¯æŒå¤šä¸ªæ¨¡å¼çš„æ•°ç»„
      action: "block"

    # å°†å†…éƒ¨åŸŸåè·¯ç”±åˆ°å†…éƒ¨è§£æå™¨
    - match: "wildcard"
      patterns: ["*.corp.local", "*.corp.internal"] # æ”¯æŒå¤šä¸ªæ¨¡å¼çš„æ•°ç»„
      action: "forward"
      target: "internal_doh"

    # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œæ¨¡å¼åŒ¹é…
    - match: "regex"
      patterns: ["^(video|audio)-cdn\\..+\\.com$"]
      action: "forward"
      target: "google_public"

    # é»˜è®¤è§„åˆ™ï¼šå°†æ‰€æœ‰å…¶ä»–æµé‡è½¬å‘åˆ° google_public
    - match: "wildcard"
      patterns: ["*"]
      action: "forward"
      target: "google_public"
```

## å¼€æºè®¸å¯

[MIT è®¸å¯è¯](LICENSE)

## è‡´è°¢

-   æ„Ÿè°¢æ‰€æœ‰ä¸º Load Ants é¡¹ç›®åšå‡ºè´¡çŒ®çš„å¼€å‘è€…
-   æœ¬é¡¹ç›®å—ç°ä»£ DoH å®ç°æŠ€æœ¯å’Œçµæ´» DNS è·¯ç”±éœ€æ±‚çš„å¯å‘
